# 长时间代理工作流 - 使用指南

---

## 文档信息

| 属性 | 内容 |
|------|------|
| 版本 | V1.2 |
| 创建日期 | 2025-12-16 |
| 参考 | [Anthropic: Effective harnesses for long-running agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents) |

### 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| V1.0 | 2025-12-15 | 初始版本 |
| V1.1 | 2025-12-16 | 补充移动端（Android 大麦 App）需求变更提醒、单目录 driver_type 策略 |
| V1.2 | 2025-12-17 | 加入 Trae 使用约定、统一浏览器自动化测试规范、完善 feature_list.json 字段 |

---

## 一、方法论核心

### 核心问题
AI 代理的每个新会话都是"失忆"的——无法记住上次做了什么。

### 解决方案
通过**结构化文件**在会话间传递上下文：
1. `feature_list.json` - 功能清单（做什么）
2. `claude-progress.txt` - 进度日志（做到哪了）
3. `init.sh` - 环境初始化（怎么跑起来）

---

## 二、新项目启动流程

### 阶段 1：需求文档阶段

```
用户：描述需求
   ↓
AI：创建 PRD 文档
   ↓
用户：澄清/确认需求
   ↓
AI：创建 SPEC 技术规格文档
AI：创建 UI 设计文档（如需要）
```

### 阶段 2：工作流初始化（关键步骤）

完成需求文档后，**告诉 AI**：

> "按照长时间代理工作流方法，初始化项目：
> 1. 从 PRD 生成 feature_list.json
> 2. 创建 claude-progress.txt
> 3. 创建 init.sh
> 4. 创建项目目录结构"

或者更简洁：

> "初始化长时间代理工作流支持文件"

### 阶段 3：开发阶段

```
每次会话开始：
   ↓
读取 claude-progress.txt（了解进度）
   ↓
读取 feature_list.json（确定下一个功能）
   ↓
实现一个功能
   ↓
测试验证
   ↓
更新 feature_list.json（标记 passes: true）
   ↓
更新 claude-progress.txt（记录完成内容）
   ↓
Git commit
   ↓
会话结束
```

---

## 三、日常开发对话模板

### 会话开始（每次新对话）

```
请先读取项目进度：
1. 读取 claude-progress.txt 了解当前进度
2. 读取 feature_list.json 查看下一个待完成功能
3. 继续开发下一个功能
```

或者更简洁：

```
继续开发，先读取进度文件
```

### 功能完成时

```
这个功能已完成，请：
1. 更新 feature_list.json 标记 passes: true
2. 更新 claude-progress.txt 记录进度
3. 提交 git commit
```

### 会话中断时

如果工作到一半需要结束会话：

```
我需要暂停，请：
1. 更新 claude-progress.txt 记录当前状态和阻塞点
2. 确保代码处于可运行状态
3. 提交 git commit
```

---

## 四、模板文件

### 4.1 feature_list.json 模板

```json
{
  "project": "项目名称",
  "version": "1.0",
  "created_at": "YYYY-MM-DD",
  "total_features": 0,
  "features": [
    {
      "id": "FEAT-001",
      "title": "功能标题",
      "category": "模块名称",
      "description": "功能描述",
      "priority": "P0",
      "steps": [
        "实现步骤1",
        "实现步骤2"
      ],
      "passes": false
    }
  ],
  "summary": {
    "模块1": 10,
    "模块2": 5,
    "total": 15
  }
}
```

### 4.2 claude-progress.txt 模板

```markdown
# 项目名称 - AI 代理进度日志

---

## 最新状态

| 属性 | 内容 |
|------|------|
| 最后更新 | YYYY-MM-DD HH:MM |
| 当前功能 | FEAT-XXX |
| 代码状态 | ✅ 可运行 / ⏳ 进行中 / ❌ 有问题 |
| 最后 Commit | xxxxxxx |

## 本次验证（浏览器自动化）

- 框架：Playwright/Cypress（按项目实际）
- 覆盖路径：列出主要用户路径
- 结果：通过 / 失败
- 证据：截图 / 视频 / 日志路径

---

## 项目进度总览

- **总功能数**: XX
- **已完成**: X
- **进行中**: X
- **待开始**: XX
- **完成率**: X%

---

## 会话记录

### YYYY-MM-DD 会话 N

**完成内容**:
- ✅ 功能1
- ✅ 功能2

**当前状态**:
- 描述当前代码状态

**本次验证**:
- 结果：通过 / 失败
- 证据：screenshots/videos 路径

**下一步**:
1. 下一个功能
2. ...

---

## 下一个待完成功能

| ID | 描述 | 优先级 |
|----|------|--------|
| FEAT-XXX | 功能描述 | P0 |

---

## 已知问题

- [ ] 问题1
- [ ] 问题2

---
```

### 4.3 init.sh 模板

```bash
#!/bin/bash
# 项目初始化脚本

set -e

echo "=== 项目名称 - 环境初始化 ==="

# 1. 检查 Python（根据项目调整）
python3 --version

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 创建目录结构（根据项目调整）
mkdir -p src/{module1,module2}
mkdir -p data
mkdir -p logs

# 5. 显示状态
git status
git log --oneline -5

echo "=== 初始化完成 ==="
```

---

## 五、Trae 使用约定（通用版）

将以下内容添加到 Cursor → Settings → Rules → User Rules：

```markdown
## 长时间任务管理规范

### 项目初始化
- 完成需求文档后，创建 feature_list.json、claude-progress.txt、init.sh
- feature_list.json 使用 JSON 格式，从需求文档提取功能点
- 每个功能标记 passes: false，完成后改为 true

### 会话开始流程
1. 读取 claude-progress.txt 了解当前进度
2. 读取 feature_list.json 确认下一个待完成功能
3. 检查 git log 了解最近代码变更

### 增量开发原则
- 每次会话只实现一个功能
- 功能完成后进行浏览器自动化端到端测试（除非无法在前端测试）
- 测试通过后更新 feature_list.json 的 passes 状态

### 会话结束流程
1. 确保代码可运行
2. 更新 claude-progress.txt
3. 提交 git commit

### 代码状态要求
- 每次会话结束时代码应可合并到 main
- 不留下半完成功能或明显 Bug
- 如无法完成，记录阻塞原因
```

---

## 六、完整使用流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        新项目启动流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  【第1步：需求阶段】                                                 │
│  用户描述需求 → AI 创建 PRD → 用户确认 → AI 创建 SPEC/UI            │
│                                                                     │
│  【第2步：初始化工作流】（一次性）                                    │
│  告诉 AI："初始化长时间代理工作流"                                   │
│  ↓                                                                  │
│  AI 创建：                                                          │
│  - feature_list.json（从PRD提取功能点）                             │
│  - claude-progress.txt（进度日志模板）                               │
│  - init.sh（初始化脚本）                                            │
│  - 项目目录结构                                                     │
│                                                                     │
│  【第3步：开发循环】（每次会话重复）                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  会话开始                                                    │   │
│  │  ↓                                                          │   │
│  │  "继续开发，先读取进度文件"                                   │   │
│  │  ↓                                                          │   │
│  │  AI 读取 progress + feature_list                            │   │
│  │  ↓                                                          │   │
│  │  AI 实现下一个功能                                           │   │
│  │  ↓                                                          │   │
│  │  测试验证                                                    │   │
│  │  ↓                                                          │   │
│  │  AI 更新 progress + feature_list + git commit               │   │
│  │  ↓                                                          │   │
│  │  会话结束 ─────→ 下一个会话（循环）                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  【第4步：项目完成】                                                 │
│  所有 feature_list 中的 passes 都为 true                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 七、常用对话指令速查

| 场景 | 对话指令 |
|------|----------|
| 新项目初始化工作流 | "初始化长时间代理工作流支持文件" |
| 开始新会话 | "继续开发，先读取进度文件" |
| 功能完成 | "更新进度文件和功能清单" |
| 暂停工作 | "记录当前进度，确保代码可运行后提交" |
| 查看进度 | "读取 feature_list.json 显示完成情况" |
| 跳过当前功能 | "跳过当前功能，记录原因，继续下一个" |
| 测试验证（浏览器自动化） | "运行浏览器自动化测试，记录证据并更新进度" |

---

## 八、注意事项

### ✅ 推荐做法

1. **每次新对话都提醒读取进度文件** - AI 不会自动记住上次做了什么
2. **功能完成后立即更新文件** - 不要积累多个功能再更新
3. **保持代码可运行** - 每次会话结束时代码应能正常运行
4. **使用 JSON 格式的功能清单** - AI 不容易随意修改 JSON 结构
5. **移动端变更提示** - 如加入 Android/App 支持，提醒统一 driver_type 命名、更新进度/日志/文档版本

### ❌ 避免做法

1. **一次实现多个功能** - 容易上下文耗尽导致半完成
2. **忘记更新进度文件** - 下次会话会丢失进度信息
3. **留下损坏的代码** - 应该 revert 到可工作状态
4. **使用 Markdown 格式的功能清单** - AI 可能会误删或修改内容
5. **文档与代码命名不一致** - 新增移动端时若继续单目录（如 `platforms/damai`），需在文档中说明用 driver_type 区分；如改目录则同步更新文档

---

## 九、浏览器自动化测试规范

- 原则：除非无法在前端测试，否则一律使用浏览器自动化进行端到端验证
- 层级：冒烟（关键路径）、功能（每特性）、回归（关键组合与跨页）
- 选择器：统一使用 `data-testid` 进行稳定定位，避免纯文本或复杂 CSS 依赖
- 断言：以用户可见结果为准（元素可见、文本正确、路由状态、网络响应呈现）
- 运行：本地启动预览/开发服务后执行测试；生成截图/视频并在 `claude-progress.txt` 记录证据
- 例外：仅后端任务、第三方回调、无 UI 接入等不可在前端测试的场景，改用 API/集成测试，并在进度文件注明原因与覆盖范围
- 映射：每个 `feature_list.json` 条目需维护 `test.scenario`，与实际自动化用例一一对应

---

*文档结束*
