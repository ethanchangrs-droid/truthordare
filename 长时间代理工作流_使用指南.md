# 长时间代理工作流 - 使用指南

## 核心文件说明

### 1. feature_list.json - 唯一任务清单 ⭐
**作用**: 记录项目所有功能和任务，无论完成状态

**格式**:
```json
[
  {
    "id": "F-001",
    "title": "功能描述",
    "passes": true/false,
    "priority": "P0/P1/P2/P3",
    "note": "备注说明"
  }
]
```

**优先级定义**:
- P0: 核心功能，必须完成
- P1: 重要功能，尽快完成
- P2: 优化项，有时间再做
- P3: 未来版本功能

**使用规范**:
- ✅ 从需求文档提取**所有功能点**
- ✅ 新任务直接添加到此文件
- ✅ 完成后更新 `passes: true`
- ✅ 查看待办直接看这个文件
- ❌ 不要只记录顶层功能
- ❌ 不要把任务散落在其他文档中

### 2. claude-progress.txt - 会话日志
**作用**: 记录每次会话完成了什么，下一步做什么

**格式**:
```
日期(UTC+8): YYYY-MM-DD HH:MM:SS CST
完成内容: 
  - 本次会话完成的任务列表
当前状态: 
  - 项目整体状态概述
下一步: 
  - 下次会话应该做什么
已知问题: 
  - 当前存在的问题
Commit Hash: xxxxxx
```

**使用规范**:
- ✅ 每次会话结束必须更新
- ✅ 记录 git commit hash
- ✅ 明确标注下一步任务
- ❌ 不要在这里管理任务清单（应该在 feature_list.json）

### 3. init.sh - 环境初始化脚本
**作用**: 快速启动开发环境

**内容**:
```bash
#!/bin/bash
# 安装依赖
cd backend && npm install
cd ../web && npm install

# 启动服务
cd ../backend && npm run dev &
cd ../web && npm run dev &
```

## 会话开始流程 SOP

1. **确认工作目录**
   ```bash
   pwd
   ```

2. **读取进度文件**
   ```bash
   cat claude-progress.txt
   ```

3. **查看功能清单**
   ```bash
   cat feature_list.json
   ```
   - 找到下一个 `passes: false` 的任务
   - 按 priority 优先级选择

4. **检查 Git 状态**
   ```bash
   git log --oneline -5
   git status
   ```

5. **如有 init.sh，确保环境正常**

## 增量开发原则

### ✅ 正确做法
- 每次会话只实现**一个功能**（feature_list 中的一条）
- 功能完成后**必须进行端到端测试**
- 测试通过后，更新 `passes: true`
- 提交 git commit（遵循约定式提交格式）

### ❌ 错误做法
- 一次性实现多个功能
- 不测试就标记为完成
- 半完成状态就提交代码

## 会话结束流程 SOP

1. **确保代码可运行**
   - 无语法错误
   - 无明显 Bug
   - 如无法完成，回退到可工作状态

2. **提交 Git**
   ```bash
   git add -A
   git commit -m "type(scope): subject"
   ```

3. **更新 feature_list.json**
   - 完成的功能标记 `passes: true`

4. **更新 claude-progress.txt**
   - 记录完成内容
   - 更新 commit hash
   - 明确下一步任务

## 常见错误与修正

### 错误 1: 功能清单不完整
❌ **错误**: 只在 feature_list.json 中记录 5 个高层次功能
✅ **修正**: 从需求文档提取**所有功能点**，包括优化项、测试、部署等

### 错误 2: 任务分散在多个文档
❌ **错误**: 
- PRD → "待澄清项"
- SPEC → "待实现"标注
- 评估报告 → "改进建议"

✅ **修正**: 所有任务统一记录在 `feature_list.json`

### 错误 3: 进度文件不更新
❌ **错误**: feature_list.json 所有 `passes` 仍为 `false`
✅ **修正**: 功能完成并测试通过后，立即更新状态

## 文档与代码一致性

### 原则
- 代码实现必须符合 PRD 中的功能需求
- 技术实现必须遵循 SPEC 中的架构设计
- 前端实现必须符合 UI 设计文档
- 如需偏离文档，必须在代码注释中说明原因

### 对齐检查
- 定期检查代码与文档是否一致
- 发现不一致时，优先以文档为准
- 如文档有误，先更新文档再修改代码

## 经验教训

### 1. feature_list.json 的正确使用
- **它是任务管理工具，不是验收清单**
- 应该包含所有功能，从 MVP 到 V2 的所有规划
- 用 priority 字段控制开发顺序
- 用 passes 字段标记完成状态

### 2. 代码与文档对齐的重要性
- 风格枚举必须一致
- API 参数命名必须一致
- 功能实现状态必须同步到文档

### 3. 端到端测试的必要性
- 功能写完≠功能完成
- 必须实际运行测试
- 测试通过才能标记 `passes: true`

## 快速参考

| 文件 | 作用 | 更新时机 |
|------|------|---------|
| feature_list.json | 任务清单 | 添加任务/完成任务时 |
| claude-progress.txt | 会话日志 | 每次会话结束时 |
| PRD/SPEC/UI | 需求设计 | 需求变更时 |
| README.md | 项目说明 | 架构变更时 |

---

**最后提醒**: 
- 查任务 → 看 feature_list.json
- 查进度 → 看 claude-progress.txt
- 查需求 → 看 PRD/SPEC/UI
