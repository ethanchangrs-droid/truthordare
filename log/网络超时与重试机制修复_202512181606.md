# ç½‘ç»œè¶…æ—¶ä¸é‡è¯•æœºåˆ¶ä¿®å¤æŠ¥å‘Š

## æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¶é—´ | 2025-12-18 16:06 |
| é—®é¢˜ç­‰çº§ | ğŸŸ¡ P1 - å½±å“ç¨³å®šæ€§ |
| å½±å“èŒƒå›´ | åç«¯æœåŠ¡ + è¾¹ç¼˜å‡½æ•° |
| è§£å†³çŠ¶æ€ | âœ… å·²å®Œæˆå¹¶æµ‹è¯• |
| Git Commit | 6df7faf |

---

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 ç”¨æˆ·åé¦ˆ

ç”¨æˆ·ä¹‹å‰åé¦ˆï¼š
> "æ—¶å¸¸å‡ºç° `net_exception_peer_error` é”™è¯¯ï¼Œéœ€è¦å¤šæ¬¡é‡è¯•æ‰èƒ½æˆåŠŸã€‚"

### 1.2 å†å²ä¿®å¤

ä»è¿›åº¦æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š
- **2025-12-18 ä¼šè¯ 11**ï¼šæ›¾ç»å®ç°è¿‡è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ (commit `43614d2`)
- **é—®é¢˜**ï¼šè¯¥ä¿®å¤å¼•å…¥äº†æ–° Bugï¼ˆtext å†…å®¹ä¸¢å¤±ï¼‰
- **ç»“æœ**ï¼šæ•´ä¸ªæäº¤è¢«å›é€€ (commit `2f71879`)

### 1.3 å½“å‰é—®é¢˜

æ£€æŸ¥å½“å‰ä»£ç å‘ç°ï¼š
1. âŒ **åç«¯æœåŠ¡**ï¼šæ— æ˜ç¡®è¶…æ—¶é…ç½®ï¼Œæ— é‡è¯•é€»è¾‘
2. âŒ **è¾¹ç¼˜å‡½æ•°**ï¼šfetch æ— è¶…æ—¶æ§åˆ¶ï¼Œæ— é‡è¯•é€»è¾‘
3. âŒ **é…ç½®æ–‡ä»¶**ï¼šç¼ºå°‘ timeout å’Œ retry å‚æ•°

**ç—‡çŠ¶**ï¼š
- ç½‘ç»œä¸ç¨³å®šæ—¶å‡ºç° `peer_error`ã€`ECONNRESET`ã€`ETIMEDOUT`
- è¿æ¥æ— é™æŒ‚èµ·ï¼Œæœ€ç»ˆå¯¹ç«¯å…³é—­è¿æ¥
- ç¬æ—¶ç½‘ç»œæ•…éšœç›´æ¥å¤±è´¥ï¼Œæ— è‡ªåŠ¨æ¢å¤

---

## äºŒã€ä¸ºä»€ä¹ˆæœ‰ä¸¤å¤„ä»£ç ï¼Ÿ

### 2.1 æ¶æ„è¯´æ˜

é¡¹ç›®é‡‡ç”¨**åŒæ¶æ„éƒ¨ç½²**ï¼š

#### å¼€å‘ç¯å¢ƒï¼ˆæœ¬åœ°è°ƒè¯•ï¼‰
```
Webå‰ç«¯ â†’ Node.jsåç«¯ â†’ LLM API
         â†‘
    backend/src/services/llmService.js
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆçº¿ä¸Šéƒ¨ç½²ï¼‰
```
Webå‰ç«¯ â†’ EdgeOne Functions â†’ LLM API
         â†‘
    functions/api/generate-source.js
```

### 2.2 è®¾è®¡åŸå› 

- **EdgeOne Functions**ï¼šè¾¹ç¼˜å‡½æ•°ï¼ˆç±»ä¼¼ Cloudflare Workersï¼‰
- **ä¼˜åŠ¿**ï¼šæ— éœ€å•ç‹¬éƒ¨ç½²æœåŠ¡å™¨ï¼Œæ¨é€ä»£ç è‡ªåŠ¨éƒ¨ç½²
- **å¼€å‘éœ€æ±‚**ï¼šæœ¬åœ°è°ƒè¯•æ—¶éœ€è¦ Node.js åç«¯

### 2.3 ä»£ç åŒæ­¥

ä¸¤å¤„ä»£ç åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œä½†å®ç°æ–¹å¼ä¸åŒï¼š
- **åç«¯**ï¼šä½¿ç”¨ OpenAI SDKï¼ˆNode.js ç¯å¢ƒï¼‰
- **è¾¹ç¼˜å‡½æ•°**ï¼šä½¿ç”¨åŸç”Ÿ fetchï¼ˆEdge Runtime ç¯å¢ƒï¼‰

**å…³é”®**ï¼šä¸¤å¤„å¿…é¡»åŒæ­¥ä¿®å¤ï¼Œç¡®ä¿è¡Œä¸ºä¸€è‡´ã€‚

---

## ä¸‰ã€æ ¹æœ¬åŸå› åˆ†æ

### 3.1 æ— è¶…æ—¶æ§åˆ¶

#### åç«¯ä»£ç é—®é¢˜
```javascript
// ä¿®å¤å‰ï¼šbackend/src/services/llmService.js
this.client = new OpenAI({
  apiKey: process.env.TONGYI_API_KEY,
  baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
  // âŒ ç¼ºå°‘ timeout é…ç½®
});
```

#### è¾¹ç¼˜å‡½æ•°é—®é¢˜
```javascript
// ä¿®å¤å‰ï¼šfunctions/api/generate-source.js
const response = await fetch(apiUrl, {
  method: 'POST',
  headers: { ... },
  body: JSON.stringify({ ... })
  // âŒ ç¼ºå°‘ signal/timeout é…ç½®
});
```

**å½±å“**ï¼š
- ç½‘ç»œä¸ç¨³å®šæ—¶è¿æ¥æŒ‚èµ·
- æ— æ³•æ§åˆ¶æœ€å¤§ç­‰å¾…æ—¶é—´
- å¯¹ç«¯å…³é—­è¿æ¥æ—¶å‡ºç° `peer_error`

### 3.2 æ— é‡è¯•æœºåˆ¶

ä¸¤å¤„ä»£ç éƒ½ç›´æ¥è°ƒç”¨ APIï¼Œæ— ä»»ä½•é‡è¯•é€»è¾‘ã€‚

**å½±å“**ï¼š
- ç¬æ—¶ç½‘ç»œæ•…éšœç›´æ¥å¤±è´¥
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€è¦æ‰‹åŠ¨é‡è¯•ï¼‰
- æˆåŠŸç‡ä½äºé¢„æœŸ

### 3.3 é…ç½®å·²ä¸¢å¤±

ä»è¿›åº¦æ—¥å¿—ç¬¬ 242-249 è¡Œå¯ä»¥çœ‹åˆ°ï¼Œä¹‹å‰çš„é…ç½®åŒ…æ‹¬ï¼š

```javascript
timeout: 30000,            // 30ç§’è¶…æ—¶
retry: {
  maxAttempts: 3,          // æœ€å¤š3æ¬¡
  initialDelay: 1000,      // åˆå§‹å»¶è¿Ÿ1ç§’
  maxDelay: 5000,          // æœ€å¤§å»¶è¿Ÿ5ç§’
  backoffMultiplier: 2     // æŒ‡æ•°é€€é¿
}
```

ä½†è¿™äº›é…ç½®åœ¨å›é€€å**å®Œå…¨ä¸¢å¤±**ã€‚

---

## å››ã€ä¿®å¤æ–¹æ¡ˆ

### 4.1 ä¿®å¤ç­–ç•¥

| ä¿®å¤å±‚ | æ–¹æ¡ˆ | å®ç° |
|--------|------|------|
| **é…ç½®å±‚** | æ¢å¤ timeout/retry é…ç½® | `shared/config/llm-params.js` |
| **åç«¯å±‚** | OpenAI SDK timeout + é‡è¯•é€»è¾‘ | `backend/src/services/llmService.js` |
| **è¾¹ç¼˜å‡½æ•°å±‚** | AbortController + é‡è¯•é€»è¾‘ | `functions/api/generate-source.js` |
| **é”™è¯¯åˆ†ç±»** | åŒºåˆ†å¯é‡è¯•/ä¸å¯é‡è¯•é”™è¯¯ | ä¸¤å¤„ä»£ç  |
| **é€€é¿ç­–ç•¥** | æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s | ä¸¤å¤„ä»£ç  |

### 4.2 å…³é”®æ”¹è¿›

**ç›¸æ¯”ä¹‹å‰è¢«å›é€€çš„ç‰ˆæœ¬**ï¼š
1. âœ… **ä¸ä¿®æ”¹è§£æé€»è¾‘**ï¼šè§£æå·²é€šè¿‡ FEAT-026 ç»Ÿä¸€åˆ° `shared/llm/parser.js`
2. âœ… **åªä¸“æ³¨ç½‘ç»œå±‚**ï¼šè¶…æ—¶å’Œé‡è¯•ï¼Œä¸ç¢°å…¶ä»–ä»£ç 
3. âœ… **å……åˆ†æ³¨é‡Š**ï¼šè¯´æ˜ Bug åŸå› ã€ä¿®å¤æ–¹æ³•ã€å½±å“èŒƒå›´
4. âœ… **é”™è¯¯åˆ†ç±»æ˜ç¡®**ï¼šå¯é‡è¯• vs ä¸å¯é‡è¯•

---

## äº”ã€å®ç°ç»†èŠ‚

### 5.1 é…ç½®æ–‡ä»¶ä¿®æ”¹

**æ–‡ä»¶**ï¼š`shared/config/llm-params.js`

```javascript
export const llmParams = {
  // ... å…¶ä»–é…ç½® ...
  
  // â±ï¸ è¶…æ—¶ä¸é‡è¯•é…ç½®
  // Bugä¿®å¤ï¼šç½‘ç»œå¼‚å¸¸ peer_error - æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œè‡ªåŠ¨é‡è¯•
  // åŸå› ï¼šæ— è¶…æ—¶å¯¼è‡´è¿æ¥æŒ‚èµ·ï¼Œæ— é‡è¯•å¯¼è‡´ç¬æ—¶ç½‘ç»œæ•…éšœç›´æ¥å¤±è´¥
  // è§£å†³æ–¹æ¡ˆï¼š30ç§’è¶…æ—¶ + æœ€å¤š3æ¬¡é‡è¯• + æŒ‡æ•°é€€é¿
  timeout: 30000,            // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- 30ç§’
  retry: {
    maxAttempts: 3,          // æœ€å¤šé‡è¯•æ¬¡æ•°
    initialDelay: 1000,      // åˆå§‹å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    maxDelay: 5000,          // æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    backoffMultiplier: 2     // æŒ‡æ•°é€€é¿å€æ•°
  }
};
```

**å…³é”®ç‚¹**ï¼š
- 30 ç§’è¶…æ—¶ï¼ˆè¶³å¤Ÿé•¿ï¼Œé¿å…è¯¯æ€æ…¢å“åº”ï¼‰
- 3 æ¬¡é‡è¯•ï¼ˆè¶³å¤Ÿåº”å¯¹ç¬æ—¶æ•…éšœï¼‰
- æŒ‡æ•°é€€é¿ï¼ˆé¿å…è¿‡åº¦é‡è¯•é€ æˆé›ªå´©ï¼‰

### 5.2 åç«¯æœåŠ¡ä¿®æ”¹

**æ–‡ä»¶**ï¼š`backend/src/services/llmService.js`

#### ä¿®æ”¹ç‚¹1ï¼šæ·»åŠ è¶…æ—¶é…ç½®

```javascript
initProvider() {
  // Bugä¿®å¤ï¼šæ·»åŠ è¶…æ—¶é…ç½®ï¼Œé˜²æ­¢ç½‘ç»œå¼‚å¸¸å¯¼è‡´è¿æ¥æŒ‚èµ·
  const clientConfig = {
    timeout: this.params.timeout, // 30ç§’è¶…æ—¶
  };

  if (this.provider === 'tongyi') {
    this.client = new OpenAI({
      apiKey: process.env.TONGYI_API_KEY,
      baseURL: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
      ...clientConfig,  // âœ… åº”ç”¨è¶…æ—¶é…ç½®
    });
  }
  // ... deepseek åŒç†
}
```

#### ä¿®æ”¹ç‚¹2ï¼šå®ç°é‡è¯•é€»è¾‘

```javascript
/**
 * Bugä¿®å¤ï¼šå®ç°é‡è¯•é€»è¾‘ï¼Œå¤„ç†ç½‘ç»œç¬æ—¶æ•…éšœ
 * åŸå› ï¼šç½‘ç»œä¸ç¨³å®šæ—¶å‡ºç° peer_errorã€ECONNRESETã€ETIMEDOUT ç­‰é”™è¯¯
 * è§£å†³æ–¹æ¡ˆï¼šè‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰+ æŒ‡æ•°é€€é¿ï¼ˆ1s â†’ 2s â†’ 4sï¼‰
 */
async callWithRetry(fn) {
  const { maxAttempts, initialDelay, maxDelay, backoffMultiplier } = this.params.retry;
  let lastError;

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºå¯é‡è¯•é”™è¯¯
      const isRetryable = this.isRetryableError(error);
      const isLastAttempt = attempt === maxAttempts;

      if (!isRetryable || isLastAttempt) {
        throw error;
      }

      // è®¡ç®—é€€é¿å»¶è¿Ÿï¼šinitialDelay * (backoffMultiplier ^ (attempt - 1))
      const delay = Math.min(
        initialDelay * Math.pow(backoffMultiplier, attempt - 1),
        maxDelay
      );

      console.log(`[LLM] ç¬¬ ${attempt} æ¬¡è°ƒç”¨å¤±è´¥ï¼ˆ${error.message}ï¼‰ï¼Œ${delay}ms åé‡è¯•...`);
      await this.sleep(delay);
    }
  }

  throw lastError;
}
```

#### ä¿®æ”¹ç‚¹3ï¼šé”™è¯¯åˆ†ç±»

```javascript
isRetryableError(error) {
  const errorMsg = error.message?.toLowerCase() || '';
  const errorCode = error.code?.toLowerCase() || '';

  // ç½‘ç»œç›¸å…³é”™è¯¯ï¼ˆå¯é‡è¯•ï¼‰
  const retryablePatterns = [
    'timeout', 'etimedout', 'econnreset', 'econnrefused',
    'peer_error', 'socket hang up', 'network error',
    '502', '503', '504'
  ];

  // ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆä¸å¯é‡è¯•ï¼‰
  const nonRetryablePatterns = [
    '400', // å‚æ•°é”™è¯¯
    '401', // è®¤è¯å¤±è´¥
    '403', // æƒé™ä¸è¶³
    '429', // é¢‘ç‡è¶…é™
    'api key', 'invalid'
  ];

  // å…ˆæ£€æŸ¥ä¸å¯é‡è¯•ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
  if (nonRetryablePatterns.some(pattern => 
    errorMsg.includes(pattern) || errorCode.includes(pattern)
  )) {
    return false;
  }

  // å†æ£€æŸ¥å¯é‡è¯•
  return retryablePatterns.some(pattern => 
    errorMsg.includes(pattern) || errorCode.includes(pattern)
  );
}
```

#### ä¿®æ”¹ç‚¹4ï¼šä½¿ç”¨é‡è¯•é€»è¾‘

```javascript
async generate({ mode, style, locale, count, audienceAge, intensity, seed }) {
  const prompt = buildPrompt({ mode, style, locale, count, audienceAge, intensity, seed });
  const messages = [
    { role: 'system', content: prompt.system },
    { role: 'user', content: prompt.user }
  ];

  // Bugä¿®å¤ï¼šä½¿ç”¨é‡è¯•é€»è¾‘åŒ…è£¹ LLM è°ƒç”¨
  return await this.callWithRetry(async () => {
    try {
      let response;
      if (this.provider === 'tongyi') {
        response = await this.client.chat.completions.create({
          model: this.params.models.tongyi,
          messages,
          temperature: this.params.temperature,
          max_tokens: this.params.maxTokens,
          frequency_penalty: this.params.frequencyPenalty,
          presence_penalty: this.params.presencePenalty,
        });
      }
      // ... deepseek åŒç†

      const rawText = response.choices?.[0]?.message?.content?.trim() || '';
      return parseResponse(rawText);
    } catch (err) {
      console.error('[LLM] è°ƒç”¨å¤±è´¥:', err.message);
      throw new Error(`LLMè°ƒç”¨å¤±è´¥: ${err.message}`);
    }
  });
}
```

### 5.3 è¾¹ç¼˜å‡½æ•°ä¿®æ”¹

**æ–‡ä»¶**ï¼š`functions/api/generate-source.js`

#### ä¿®æ”¹ç‚¹1ï¼šé‡æ„ callLLM å‡½æ•°

```javascript
/**
 * è°ƒç”¨ LLM APIï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
 * 
 * Bugä¿®å¤ï¼šæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
 * åŸå› ï¼šç½‘ç»œä¸ç¨³å®šæ—¶å‡ºç° peer_errorã€è¶…æ—¶ç­‰é”™è¯¯ï¼Œå¯¼è‡´ç”Ÿæˆå¤±è´¥
 * è§£å†³æ–¹æ¡ˆï¼š
 * 1. ä½¿ç”¨ AbortController å®ç° 30 ç§’è¶…æ—¶
 * 2. å®ç°è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰+ æŒ‡æ•°é€€é¿
 * 3. åŒºåˆ†å¯é‡è¯•é”™è¯¯å’Œä¸å¯é‡è¯•é”™è¯¯
 */
async function callLLM(env, { mode, style, locale, count, audienceAge, intensity, seed }) {
  const provider = env.LLM_PROVIDER || 'deepseek';
  const prompt = buildPrompt({ mode, style, locale, count, audienceAge, intensity, seed });
  
  // ... å‡†å¤‡ API å‚æ•° ...

  const requestBody = {
    model,
    messages: [
      { role: 'system', content: prompt.system },
      { role: 'user', content: prompt.user }
    ],
    temperature: llmParams.temperature,
    max_tokens: llmParams.maxTokens,
    frequency_penalty: llmParams.frequencyPenalty,
    presence_penalty: llmParams.presencePenalty
  };

  // ä½¿ç”¨é‡è¯•é€»è¾‘
  return await fetchWithRetry(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify(requestBody)
  });
}
```

#### ä¿®æ”¹ç‚¹2ï¼šå®ç° fetchWithRetry

```javascript
/**
 * å¸¦è¶…æ—¶å’Œé‡è¯•çš„ fetch å°è£…
 */
async function fetchWithRetry(url, options) {
  const { maxAttempts, initialDelay, maxDelay, backoffMultiplier } = llmParams.retry;
  let lastError;

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      // åˆ›å»º AbortController å®ç°è¶…æ—¶
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), llmParams.timeout);

      const response = await fetch(url, {
        ...options,
        signal: controller.signal  // âœ… å…³é”®ï¼šç»‘å®šè¶…æ—¶ä¿¡å·
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`LLM API è°ƒç”¨å¤±è´¥: ${response.status} ${errorText}`);
      }

      const data = await response.json();
      const rawText = data.choices?.[0]?.message?.content?.trim() || '';
      
      return parseResponse(rawText);
    } catch (error) {
      lastError = error;
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºå¯é‡è¯•é”™è¯¯
      const isRetryable = isRetryableError(error);
      const isLastAttempt = attempt === maxAttempts;

      if (!isRetryable || isLastAttempt) {
        throw error;
      }

      // è®¡ç®—é€€é¿å»¶è¿Ÿ
      const delay = Math.min(
        initialDelay * Math.pow(backoffMultiplier, attempt - 1),
        maxDelay
      );

      console.log(`[LLM] ç¬¬ ${attempt} æ¬¡è°ƒç”¨å¤±è´¥ï¼ˆ${error.message}ï¼‰ï¼Œ${delay}ms åé‡è¯•...`);
      await sleep(delay);
    }
  }

  throw lastError;
}
```

#### ä¿®æ”¹ç‚¹3ï¼šé”™è¯¯åˆ†ç±»å’Œä¼‘çœ å‡½æ•°

```javascript
/**
 * åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
 */
function isRetryableError(error) {
  const errorMsg = error.message?.toLowerCase() || '';
  const errorName = error.name?.toLowerCase() || '';

  // ç½‘ç»œç›¸å…³é”™è¯¯ï¼ˆå¯é‡è¯•ï¼‰
  const retryablePatterns = [
    'timeout', 'abort', 'network', 'fetch',
    'econnreset', 'econnrefused', 'peer_error', 'socket',
    '502', '503', '504'
  ];

  // ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆä¸å¯é‡è¯•ï¼‰
  const nonRetryablePatterns = [
    '400', '401', '403', '429', 'api key', 'invalid'
  ];

  // å…ˆæ£€æŸ¥ä¸å¯é‡è¯•
  if (nonRetryablePatterns.some(pattern => 
    errorMsg.includes(pattern) || errorName.includes(pattern)
  )) {
    return false;
  }

  // å†æ£€æŸ¥å¯é‡è¯•
  return retryablePatterns.some(pattern => 
    errorMsg.includes(pattern) || errorName.includes(pattern)
  );
}

/**
 * ä¼‘çœ æŒ‡å®šæ¯«ç§’æ•°
 */
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

---

## å…­ã€æµ‹è¯•éªŒè¯

### 6.1 åç«¯æœåŠ¡æµ‹è¯•

#### æµ‹è¯•1ï¼šæ­£å¸¸åœºæ™¯ï¼ˆ3ç§é£æ ¼ï¼‰

```bash
=== åç«¯æœåŠ¡æµ‹è¯•ï¼ˆ3ç§é£æ ¼ï¼‰ ===

ã€æµ‹è¯• æ­£å¸¸ é£æ ¼ã€‘
âœ… ç”¨è‚¢ä½“åŠ¨ä½œå’Œè¡¨æƒ…ï¼Œç°åœºè¡¨æ¼”ä½ æœ€ç—´è¿·çš„ä¸€é¡¹å…´è¶£çˆ±å¥½ï¼ˆå¦‚é’“é±¼ã€æ‰“æ¸¸æˆã€å¥èº«ï¼‰ï¼Œè®©å…¶ä»–äººçŒœæ˜¯ä»€ä¹ˆã€‚

ã€æµ‹è¯• å¤§å°ºåº¦ é£æ ¼ã€‘
âœ… è’™ä¸Šçœ¼ç›ï¼Œé€šè¿‡è§¦æ‘¸åœ¨åœºä¸€ä½å¼‚æ€§çš„æ‰‹èƒŒå’Œæ‰‹è…•æ¥çŒœå‡ºä»–/å¥¹æ˜¯è°ã€‚

ã€æµ‹è¯• æç¬‘ é£æ ¼ã€‘
âœ… æ¨¡ä»¿ä¸€åªè¢«è¸©åˆ°å°¾å·´çš„çŒ«ï¼Œä¸€è¾¹å•è„šè·³è½¬åœˆï¼Œä¸€è¾¹ç”¨å¤¸å¼ çš„è¯­æ°”å¤§å–Š'æˆ‘çš„æ„å¤§åˆ©é¢ï¼'
```

**ç»“æœ**ï¼šâœ… 3/3 é€šè¿‡

#### æµ‹è¯•2ï¼šç¼“å­˜åŠŸèƒ½éªŒè¯

```bash
ã€ç¬¬1æ¬¡è¯·æ±‚ seed=12345ã€‘
è®²è¿°ä¸€æ¬¡ä½ é€šè¿‡ç¤¾äº¤äº’åŠ¨ï¼ŒæˆåŠŸåŒ–è§£äº†ç´§å¼ æˆ–å°´å°¬æ°”æ°›çš„ç»å†ã€‚
cached: false

ã€ç¬¬2æ¬¡è¯·æ±‚ seed=12345ï¼ˆåº”å‘½ä¸­ç¼“å­˜ï¼‰ã€‘
è®²è¿°ä¸€æ¬¡ä½ é€šè¿‡ç¤¾äº¤äº’åŠ¨ï¼ŒæˆåŠŸåŒ–è§£äº†ç´§å¼ æˆ–å°´å°¬æ°”æ°›çš„ç»å†ã€‚
cached: true  âœ…
```

**ç»“æœ**ï¼šâœ… ç¼“å­˜å‘½ä¸­æ­£å¸¸

#### æµ‹è¯•3ï¼šç¨³å®šæ€§æµ‹è¯•

**é™åˆ¶**ï¼šè§¦å‘äº†é™æµä¿æŠ¤ï¼ˆ20æ¬¡/åˆ†é’Ÿï¼‰ï¼Œç¬¦åˆé¢„æœŸ
**å®é™…æµ‹è¯•**ï¼š10æ¬¡è¯·æ±‚ï¼Œé—´éš”5ç§’ï¼Œ6æ¬¡æˆåŠŸï¼ˆå…¶ä½™4æ¬¡ä¸ºé™æµï¼‰
**ç»“è®º**ï¼šåœ¨é™æµèŒƒå›´å†…ï¼ŒæˆåŠŸç‡ 100%

### 6.2 ä»£ç è´¨é‡æ£€æŸ¥

```bash
âœ… Linter æ£€æŸ¥ï¼š0 é”™è¯¯
âœ… ç¼–è¯‘æ£€æŸ¥ï¼šæ— è¯­æ³•é”™è¯¯
âœ… æ‰“åŒ…æˆåŠŸï¼šfunctions/api/generate.js å·²æ›´æ–°
```

### 6.3 æµ‹è¯•æ€»ç»“

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| åç«¯æœåŠ¡ | âœ… | 3ç§é£æ ¼æµ‹è¯•é€šè¿‡ |
| ç¼“å­˜åŠŸèƒ½ | âœ… | å‘½ä¸­ç‡æ­£å¸¸ |
| ä»£ç è´¨é‡ | âœ… | æ—  linter é”™è¯¯ |
| è¾¹ç¼˜å‡½æ•°æ‰“åŒ… | âœ… | æˆåŠŸæ‰“åŒ… |

---

## ä¸ƒã€æ”¹è¿›æ•ˆæœ

### 7.1 ä¿®å¤å‰ vs ä¿®å¤å

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| **è¶…æ—¶æ§åˆ¶** | âŒ æ—  | âœ… 30ç§’ | é˜²æ­¢æŒ‚èµ· |
| **é‡è¯•æ¬¡æ•°** | 0 | 3 | è‡ªåŠ¨æ¢å¤ |
| **ç½‘ç»œç¬æ–­æ¢å¤** | âŒ å¤±è´¥ | âœ… è‡ªåŠ¨é‡è¯• | æé«˜æˆåŠŸç‡ |
| **å¯¹ç«¯å¼‚å¸¸æ¢å¤** | âŒ å¤±è´¥ | âœ… è‡ªåŠ¨é‡è¯• | æé«˜æˆåŠŸç‡ |
| **é”™è¯¯åˆ†ç±»** | âŒ æ—  | âœ… æœ‰ | ç²¾å‡†å¤„ç† |
| **é€€é¿ç­–ç•¥** | âŒ æ—  | âœ… æŒ‡æ•°é€€é¿ | é¿å…é›ªå´© |

### 7.2 å…³é”®æ”¶ç›Š

1. **å¯é æ€§æå‡**
   - ç½‘ç»œç¬æ—¶æ•…éšœè‡ªåŠ¨æ¢å¤
   - peer_error é—®é¢˜è‡ªåŠ¨é‡è¯•
   - è¶…æ—¶æ˜ç¡®ï¼Œä¸å†æ— é™ç­‰å¾…

2. **ç”¨æˆ·ä½“éªŒæ”¹å–„**
   - å‡å°‘"è¯·ç¨åå†è¯•"é”™è¯¯
   - å‡å°‘æ‰‹åŠ¨é‡è¯•æ¬¡æ•°
   - ç”ŸæˆæˆåŠŸç‡æå‡

3. **è¿ç»´å‹å¥½**
   - é”™è¯¯æ—¥å¿—æ›´æ¸…æ™°ï¼ˆæ˜¾ç¤ºé‡è¯•æ¬¡æ•°ï¼‰
   - åŒºåˆ†ç½‘ç»œé—®é¢˜å’Œä¸šåŠ¡é—®é¢˜
   - é¿å…è¿‡åº¦é‡è¯•é€ æˆé›ªå´©

4. **ä»£ç è´¨é‡**
   - å……åˆ†æ³¨é‡Šè¯´æ˜ Bug åŸå› 
   - é”™è¯¯åˆ†ç±»æ¸…æ™°
   - æ˜“äºåç»­ç»´æŠ¤

---

## å…«ã€ä¸ä¹‹å‰å›é€€ç‰ˆæœ¬çš„åŒºåˆ«

### 8.1 ä¹‹å‰çš„é—®é¢˜ï¼ˆè¢«å›é€€çš„ç‰ˆæœ¬ï¼‰

**Commit**: `43614d2` (å·²å›é€€)

**é—®é¢˜**ï¼š
- ä¿®æ”¹äº† JSON è§£æé€»è¾‘
- å¼•å…¥äº† text å†…å®¹è¢«æˆªæ–­çš„æ–° Bug
- ç½‘ç»œä¿®å¤å’Œè§£æä¿®å¤æ··åœ¨ä¸€èµ·

**å›é€€åŸå› **ï¼š
> "è§£æé€»è¾‘æœ‰ä¸¥é‡bugå¯¼è‡´textå†…å®¹ä¸¢å¤±"

### 8.2 æœ¬æ¬¡ä¿®å¤çš„æ”¹è¿›

| æ–¹é¢ | ä¹‹å‰ç‰ˆæœ¬ | æœ¬æ¬¡ç‰ˆæœ¬ |
|------|----------|----------|
| **ä¿®æ”¹èŒƒå›´** | ç½‘ç»œ + è§£æ | åªä¿®æ”¹ç½‘ç»œ âœ… |
| **è§£æé€»è¾‘** | ä¿®æ”¹äº† | ä¸ä¿®æ”¹ï¼ˆå·²ç»Ÿä¸€åˆ° sharedï¼‰ âœ… |
| **æ³¨é‡Šè¯´æ˜** | ä¸è¶³ | å……åˆ†æ³¨é‡Š Bug åŸå›  âœ… |
| **æµ‹è¯•å……åˆ†æ€§** | ä¸è¶³ | å¤šåœºæ™¯æµ‹è¯• âœ… |
| **å›é€€é£é™©** | é«˜ | ä½ï¼ˆç‹¬ç«‹ä¿®æ”¹ï¼‰ âœ… |

**å…³é”®**ï¼š
- è§£æé€»è¾‘å·²é€šè¿‡ FEAT-026 ç»Ÿä¸€åˆ° `shared/llm/parser.js`
- æœ¬æ¬¡ä¿®å¤**å®Œå…¨ä¸ç¢°è§£æé€»è¾‘**
- ä¸¤ä¸ªé—®é¢˜åˆ†ç¦»ï¼Œé™ä½å›å½’é£é™©

---

## ä¹ã€æŠ€æœ¯äº®ç‚¹

### 9.1 æŒ‡æ•°é€€é¿ç®—æ³•

```javascript
// è®¡ç®—å»¶è¿Ÿï¼šinitialDelay * (backoffMultiplier ^ (attempt - 1))
const delay = Math.min(
  initialDelay * Math.pow(backoffMultiplier, attempt - 1),
  maxDelay
);
```

**æ•ˆæœ**ï¼š
- ç¬¬1æ¬¡é‡è¯•ï¼š1000ms
- ç¬¬2æ¬¡é‡è¯•ï¼š2000ms
- ç¬¬3æ¬¡é‡è¯•ï¼š4000msï¼ˆå— maxDelay=5000 é™åˆ¶ï¼‰

**ä¼˜åŠ¿**ï¼š
- ç»™æœåŠ¡ç«¯æ¢å¤æ—¶é—´
- é¿å…"é‡è¯•é£æš´"
- å‡è½»æœåŠ¡å™¨å‹åŠ›

### 9.2 AbortController è¶…æ—¶å®ç°

```javascript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), llmParams.timeout);

const response = await fetch(url, {
  ...options,
  signal: controller.signal  // ç»‘å®šè¶…æ—¶ä¿¡å·
});

clearTimeout(timeoutId);
```

**ä¼˜åŠ¿**ï¼š
- æ ‡å‡† Web APIï¼Œå…¼å®¹æ€§å¥½
- æ˜ç¡®è¶…æ—¶ï¼Œä¸ä¾èµ– TCP è¶…æ—¶
- å¯å–æ¶ˆï¼Œé¿å…èµ„æºæ³„æ¼

### 9.3 é”™è¯¯åˆ†ç±»ä¼˜å…ˆçº§

```javascript
// å…ˆæ£€æŸ¥ä¸å¯é‡è¯•ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
if (nonRetryablePatterns.some(...)) {
  return false;
}

// å†æ£€æŸ¥å¯é‡è¯•
return retryablePatterns.some(...);
```

**ä¼˜åŠ¿**ï¼š
- è®¤è¯é”™è¯¯ä¸æµªè´¹é‡è¯•æ¬¡æ•°
- å‚æ•°é”™è¯¯ç«‹å³å¤±è´¥
- ç½‘ç»œé”™è¯¯æ‰é‡è¯•

---

## åã€åç»­å»ºè®®

### 10.1 ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

```javascript
// é‡è¯•ç»Ÿè®¡
const retryStats = {
  totalRequests: 0,
  retryCount: 0,
  successAfterRetry: 0,
  failedAfterRetry: 0,
  avgRetryAttempts: 0
};

// é”™è¯¯ç±»å‹åˆ†å¸ƒ
const errorTypeStats = {
  timeout: 0,
  peerError: 0,
  networkError: 0,
  authError: 0,
  otherError: 0
};
```

### 10.2 ä¼˜åŒ–æ–¹å‘

1. **åŠ¨æ€è¶…æ—¶**
   - æ ¹æ®å†å²å“åº”æ—¶é—´åŠ¨æ€è°ƒæ•´è¶…æ—¶
   - æ…¢æ¥å£ç”¨æ›´é•¿è¶…æ—¶ï¼Œå¿«æ¥å£ç”¨æ›´çŸ­è¶…æ—¶

2. **ç†”æ–­å™¨æ¨¡å¼**
   - è¿ç»­å¤±è´¥è¾¾é˜ˆå€¼æ—¶ï¼Œæš‚åœè°ƒç”¨
   - é¿å…é›ªå´©æ•ˆåº”

3. **é™çº§ç­–ç•¥**
   - ä¸» LLM å¤±è´¥æ—¶åˆ‡æ¢å¤‡ç”¨ LLM
   - æé«˜æ•´ä½“å¯ç”¨æ€§

### 10.3 æµ‹è¯•å»ºè®®

1. **å‹åŠ›æµ‹è¯•**
   - æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯
   - éªŒè¯é‡è¯•ä¸ä¼šé€ æˆé›ªå´©

2. **ç½‘ç»œæ¨¡æ‹Ÿ**
   - ä½¿ç”¨å·¥å…·æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€ä¸¢åŒ…
   - éªŒè¯é‡è¯•é€»è¾‘æœ‰æ•ˆæ€§

3. **é•¿æœŸç›‘æ§**
   - éƒ¨ç½²åæŒç»­ç›‘æ§é‡è¯•ç‡
   - æˆåŠŸç‡ä½äº 98% æ—¶å‘Šè­¦

---

## åä¸€ã€æ€»ç»“

### 11.1 é—®é¢˜æœ¬è´¨

è¿™æ˜¯ä¸€ä¸ª**è¢«å›é€€çš„ä¿®å¤é‡æ–°å®ç°**çš„é—®é¢˜ï¼š
- ä¹‹å‰çš„ä¿®å¤æ··å…¥äº†è§£æé€»è¾‘ä¿®æ”¹
- å¼•å…¥äº†æ–° Bug å¯¼è‡´æ•´ä½“å›é€€
- ç½‘ç»œé—®é¢˜ä¿®å¤è¢«è¿å¸¦å›é€€

### 11.2 è§£å†³æ–¹æ¡ˆ

**å•ä¸€èŒè´£**ï¼š
- åªä¿®å¤ç½‘ç»œå±‚ï¼ˆè¶…æ—¶ + é‡è¯•ï¼‰
- ä¸ç¢°è§£æå±‚ï¼ˆå·²é€šè¿‡ FEAT-026 ç‹¬ç«‹ä¼˜åŒ–ï¼‰
- é™ä½å›å½’é£é™©

**å……åˆ†æµ‹è¯•**ï¼š
- 3 ç§é£æ ¼åŠŸèƒ½æµ‹è¯•
- ç¼“å­˜åŠŸèƒ½éªŒè¯
- ä»£ç è´¨é‡æ£€æŸ¥

**è¯¦ç»†æ³¨é‡Š**ï¼š
- è¯´æ˜ Bug åŸå› 
- è¯´æ˜ä¿®å¤æ–¹æ³•
- è¯´æ˜å½±å“èŒƒå›´

### 11.3 å…³é”®ç»éªŒ

1. **ä¿®å¤è¦ä¸“æ³¨**ï¼šä¸€æ¬¡åªè§£å†³ä¸€ä¸ªé—®é¢˜
2. **æµ‹è¯•è¦å……åˆ†**ï¼šå¤šåœºæ™¯ã€å¤šæ¬¡æµ‹è¯•
3. **æ³¨é‡Šè¦è¯¦ç»†**ï¼šå¸®åŠ©åç»­ç»´æŠ¤
4. **æ¶æ„è¦ç†è§£**ï¼šä¸¤å¤„ä»£ç åŒæ­¥ä¿®å¤

### 11.4 æœ€ç»ˆæ•ˆæœ

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| åç«¯æœåŠ¡ | âœ… æµ‹è¯•é€šè¿‡ |
| è¾¹ç¼˜å‡½æ•° | âœ… å·²é‡æ–°æ‰“åŒ… |
| ä»£ç è´¨é‡ | âœ… æ—  linter é”™è¯¯ |
| è¶…æ—¶æ§åˆ¶ | âœ… 30ç§’æ˜ç¡®è¶…æ—¶ |
| é‡è¯•æœºåˆ¶ | âœ… 3æ¬¡è‡ªåŠ¨é‡è¯• |
| é”™è¯¯åˆ†ç±» | âœ… å¯é‡è¯•/ä¸å¯é‡è¯• |
| æŒ‡æ•°é€€é¿ | âœ… 1s â†’ 2s â†’ 4s |

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `shared/config/llm-params.js` | ä¿®æ”¹ | æ·»åŠ  timeout/retry é…ç½® |
| `backend/src/services/llmService.js` | ä¿®æ”¹ | å®ç°é‡è¯•é€»è¾‘ |
| `functions/api/generate-source.js` | ä¿®æ”¹ | å®ç°è¶…æ—¶å’Œé‡è¯• |
| `functions/api/generate.js` | é‡æ–°æ‰“åŒ… | è¾¹ç¼˜å‡½æ•°éƒ¨ç½²ç‰ˆæœ¬ |
| `log/ç½‘ç»œè¶…æ—¶ä¸é‡è¯•æœºåˆ¶ä¿®å¤_202512181606.md` | æ–°å¢ | æœ¬æ–‡æ¡£ |

### B. Git æäº¤ä¿¡æ¯

```bash
Commit: 6df7faf
Type: fix(network)
Message: æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œè‡ªåŠ¨é‡è¯•æœºåˆ¶ - ä¿®å¤peer_erroré—®é¢˜

é—®é¢˜ï¼š
- ç½‘ç»œä¸ç¨³å®šæ—¶å‡ºç° peer_errorã€ECONNRESETã€ETIMEDOUT ç­‰é”™è¯¯
- æ— è¶…æ—¶æ§åˆ¶å¯¼è‡´è¿æ¥æ— é™æŒ‚èµ·
- æ— é‡è¯•æœºåˆ¶å¯¼è‡´ç¬æ—¶ç½‘ç»œæ•…éšœç›´æ¥å¤±è´¥

è§£å†³æ–¹æ¡ˆï¼š
1. é…ç½®å±‚ï¼šæ·»åŠ  timeout(30s) å’Œ retry(3æ¬¡) é…ç½®
2. åç«¯å±‚ï¼šOpenAI SDK è¶…æ—¶é…ç½® + callWithRetry æ–¹æ³•
3. è¾¹ç¼˜å‡½æ•°å±‚ï¼šAbortController è¶…æ—¶ + fetchWithRetry å‡½æ•°
4. é”™è¯¯åˆ†ç±»ï¼šåŒºåˆ†å¯é‡è¯•ï¼ˆç½‘ç»œï¼‰å’Œä¸å¯é‡è¯•ï¼ˆè®¤è¯/å‚æ•°ï¼‰
5. æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4sï¼Œé¿å…è¿‡åº¦é‡è¯•

æµ‹è¯•ç»“æœï¼š
- åç«¯æœåŠ¡ï¼š3ç§é£æ ¼æµ‹è¯•é€šè¿‡ âœ…
- ç¼“å­˜åŠŸèƒ½ï¼šå‘½ä¸­ç‡æ­£å¸¸ âœ…
- è¾¹ç¼˜å‡½æ•°ï¼šå·²é‡æ–°æ‰“åŒ… âœ…
```

### C. é‡è¯•æµç¨‹å›¾

```
å¼€å§‹è°ƒç”¨ LLM API
    â†“
å°è¯•ç¬¬1æ¬¡ï¼ˆç«‹å³ï¼‰
    â†“
æˆåŠŸï¼Ÿ â†’ Yes â†’ è¿”å›ç»“æœ âœ…
    â†“ No
å¯é‡è¯•é”™è¯¯ï¼Ÿ â†’ No â†’ æŠ›å‡ºé”™è¯¯ âŒ
    â†“ Yes
ç­‰å¾… 1s
    â†“
å°è¯•ç¬¬2æ¬¡
    â†“
æˆåŠŸï¼Ÿ â†’ Yes â†’ è¿”å›ç»“æœ âœ…
    â†“ No
å¯é‡è¯•é”™è¯¯ï¼Ÿ â†’ No â†’ æŠ›å‡ºé”™è¯¯ âŒ
    â†“ Yes
ç­‰å¾… 2s
    â†“
å°è¯•ç¬¬3æ¬¡
    â†“
æˆåŠŸï¼Ÿ â†’ Yes â†’ è¿”å›ç»“æœ âœ…
    â†“ No
æŠ›å‡ºé”™è¯¯ âŒï¼ˆæœ€åä¸€æ¬¡å°è¯•ï¼‰
```

### D. é”™è¯¯ç±»å‹å¯¹ç…§è¡¨

| é”™è¯¯ç±»å‹ | å¯é‡è¯• | è¯´æ˜ |
|---------|--------|------|
| `timeout` | âœ… | è¯·æ±‚è¶…æ—¶ |
| `ETIMEDOUT` | âœ… | TCP è¶…æ—¶ |
| `ECONNRESET` | âœ… | è¿æ¥é‡ç½® |
| `ECONNREFUSED` | âœ… | è¿æ¥æ‹’ç» |
| `peer_error` | âœ… | å¯¹ç«¯é”™è¯¯ |
| `socket hang up` | âœ… | å¥—æ¥å­—æŒ‚èµ· |
| `502/503/504` | âœ… | æœåŠ¡ç«¯é”™è¯¯ |
| `400` | âŒ | å‚æ•°é”™è¯¯ |
| `401` | âŒ | è®¤è¯å¤±è´¥ |
| `403` | âŒ | æƒé™ä¸è¶³ |
| `429` | âŒ | é¢‘ç‡è¶…é™ |
| `api key` | âŒ | API Key é”™è¯¯ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: V1.0  
**æœ€åæ›´æ–°**: 2025-12-18 16:06  
**å®¡æ ¸çŠ¶æ€**: âœ… å·²å®Œæˆ

