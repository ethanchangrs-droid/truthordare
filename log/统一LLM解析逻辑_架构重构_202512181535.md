# ç»Ÿä¸€LLMå“åº”è§£æé€»è¾‘ - æ¶æ„é‡æ„æŠ¥å‘Š

**ä»»åŠ¡ç±»å‹**: æ¶æ„é‡æ„ (FEAT-026)  
**æ‰§è¡Œæ—¶é—´**: 2025-12-18 15:35  
**ä¼˜å…ˆçº§**: P1  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡ç›®æ ‡

å°† LLM å“åº”è§£æé€»è¾‘ä»åç«¯ï¼ˆ`backend/src/services/llmService.js`ï¼‰å’Œè¾¹ç¼˜å‡½æ•°ï¼ˆ`functions/api/generate-source.js`ï¼‰æå–åˆ°å…±äº«æ¨¡å—ï¼ˆ`shared/llm/parser.js`ï¼‰ï¼Œæ¶ˆé™¤é‡å¤ä»£ç ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰çŠ¶å†µ

åœ¨é‡æ„å‰ï¼ŒLLM å“åº”è§£æé€»è¾‘åœ¨ä¸¤ä¸ªåœ°æ–¹ç»´æŠ¤ï¼š

1. **åç«¯æœåŠ¡**: `backend/src/services/llmService.js` - ç¬¬70~151è¡Œï¼ˆ82è¡Œï¼‰
2. **è¾¹ç¼˜å‡½æ•°**: `functions/api/generate-source.js` - ç¬¬69~143è¡Œï¼ˆ75è¡Œï¼‰

**é—®é¢˜**:
- âŒ **ä»£ç é‡å¤**: ä¸¤å¤„ç»´æŠ¤ç›¸åŒçš„è§£æé€»è¾‘ï¼Œå…±è®¡ **82è¡Œé‡å¤ä»£ç **
- âŒ **ç»´æŠ¤æˆæœ¬é«˜**: ä¿®å¤ bug éœ€è¦åŒæ—¶ä¿®æ”¹ä¸¤å¤„ï¼ˆå¦‚ä¹‹å‰çš„ä¸­æ–‡å¼•å·é—®é¢˜ï¼‰
- âŒ **ä¸€è‡´æ€§é£é™©**: å®¹æ˜“å‡ºç°ä¸¤å¤„ä»£ç ä¸åŒæ­¥çš„æƒ…å†µ
- âŒ **æµ‹è¯•å†—ä½™**: éœ€è¦åœ¨ä¸¤ä¸ªç¯å¢ƒåˆ†åˆ«æµ‹è¯•ç›¸åŒçš„é€»è¾‘

### è§£æé€»è¾‘å¤æ‚åº¦

è¿™æ®µè§£æä»£ç éå¸¸å…³é”®ä¸”å¤æ‚ï¼Œéœ€è¦å¤„ç†ï¼š
- âœ… æ ‡å‡† JSON æ ¼å¼: `[{ "type": "dare", "text": "å†…å®¹" }]`
- âœ… å¤§æ‹¬å·åŒ…è£¹: `{[ {...} ]}`
- âœ… Markdown åŒ…è£¹: ` ```json [...] ``` `
- âœ… ä¸­æ–‡å…¨è§’å¼•å·: `"` (U+201C), `"` (U+201D)
- âœ… è½¬ä¹‰å­—ç¬¦: `\n`, `\"`, `\\`
- âœ… æœªè½¬ä¹‰å¼•å·: text å†…å®¹ä¸­çš„åŒå¼•å·

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

åˆ›å»ºå…±äº«è§£ææ¨¡å— `shared/llm/parser.js`ï¼Œæä¾›ç»Ÿä¸€çš„è§£æå‡½æ•°ï¼š

```
shared/
  â””â”€â”€ llm/
      â””â”€â”€ parser.js  â† æ–°å¢ï¼šç»Ÿä¸€è§£æé€»è¾‘ï¼ˆå•ä¸€çœŸå®æºï¼‰
```

### å®ç°æ­¥éª¤

#### 1ï¸âƒ£ åˆ›å»ºå…±äº«è§£ææ¨¡å—

**æ–‡ä»¶**: `shared/llm/parser.js`

- âœ… ä»ç°æœ‰ä»£ç ä¸­æå–å®Œæ•´çš„ `parseResponse` å‡½æ•°
- âœ… æ·»åŠ  JSDoc æ–‡æ¡£è¯´æ˜æ”¯æŒçš„æ ¼å¼
- âœ… ä¿ç•™æ‰€æœ‰è¾¹ç•Œæƒ…å†µå¤„ç†é€»è¾‘
- âœ… å¯¼å‡ºä¸º ES6 æ¨¡å—ï¼š`export function parseResponse(rawText)`

#### 2ï¸âƒ£ ä¿®æ”¹åç«¯æœåŠ¡

**æ–‡ä»¶**: `backend/src/services/llmService.js`

**å˜æ›´å†…å®¹**:
```javascript
// æ·»åŠ å¯¼å…¥
import { parseResponse } from '../../../shared/llm/parser.js';

// åˆ é™¤ parseResponse æ–¹æ³•ï¼ˆç¬¬70~151è¡Œï¼Œå…±82è¡Œï¼‰

// è°ƒç”¨ä¿®æ”¹
this.parseResponse(rawText)  â†’  parseResponse(rawText)
```

**å½±å“**:
- âœ… å‡å°‘ 82 è¡Œä»£ç 
- âœ… ç›´æ¥å¼•ç”¨å…±äº«æ¨¡å—ï¼ˆ`import` è¯­å¥ï¼‰
- âœ… æ— éœ€æ‰“åŒ…ï¼ŒNode.js åŸç”Ÿæ”¯æŒ ES6 æ¨¡å—

#### 3ï¸âƒ£ ä¿®æ”¹è¾¹ç¼˜å‡½æ•°

**æ–‡ä»¶**: `functions/api/generate-source.js`

**å˜æ›´å†…å®¹**:
```javascript
// æ·»åŠ å¯¼å…¥
import { parseResponse } from '../../shared/llm/parser.js';

// åˆ é™¤ parseResponse å‡½æ•°ï¼ˆç¬¬69~143è¡Œï¼Œå…±75è¡Œï¼‰

// è°ƒç”¨ä¿æŒä¸å˜ï¼ˆå·²ç»æ˜¯å‡½æ•°è°ƒç”¨ï¼‰
parseResponse(rawText)
```

**å½±å“**:
- âœ… å‡å°‘ 75 è¡Œä»£ç 
- âœ… å¼•ç”¨å…±äº«æ¨¡å—åé€šè¿‡ esbuild æ‰“åŒ…

#### 4ï¸âƒ£ é‡æ–°æ‰“åŒ…è¾¹ç¼˜å‡½æ•°

**å‘½ä»¤**: `npm run build:functions`

**éªŒè¯**:
- âœ… æ£€æŸ¥ `functions/api/generate.js` åŒ…å« `parseResponse` å‡½æ•°
- âœ… æ‰“åŒ…å¤§å°åˆç†ï¼ˆæ— é‡å¤ä¾èµ–ï¼‰

---

## âœ… æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test-parser.js`ï¼Œæµ‹è¯• 5 ç§åœºæ™¯ï¼š

| æµ‹è¯•åœºæ™¯ | è¾“å…¥æ ¼å¼ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|---------|---------|---------|---------|
| æ ‡å‡†æ ¼å¼ | `[{"type":"dare","text":"åš10ä¸ªä¿¯å§æ’‘"}]` | âœ… æˆåŠŸè§£æ | âœ… é€šè¿‡ |
| å¤§æ‹¬å·åŒ…è£¹ | `{[{"type":"truth",...}]}` | âœ… æˆåŠŸè§£æ | âœ… é€šè¿‡ |
| Markdown åŒ…è£¹ | ` ```json [...] ``` ` | âœ… æˆåŠŸè§£æ | âœ… é€šè¿‡ |
| ä¸­æ–‡å…¨è§’å¼•å· | `[{"type":"dare","text":"ç”¨"è¯±æƒ‘"çš„..."}]` | âœ… æˆåŠŸè§£æ | âœ… é€šè¿‡ |
| è½¬ä¹‰å­—ç¬¦ | `[{"type":"truth","text":"...\\n..."}]` | âœ… æˆåŠŸè§£æ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**: âœ… **5/5 é€šè¿‡**

**å‘½ä»¤**:
```bash
node test-parser.js
```

**è¾“å‡º**:
```
ğŸ§ª å¼€å§‹æµ‹è¯• LLM å“åº”è§£æå™¨...
âœ… æ ‡å‡†æ ¼å¼
âœ… å¤§æ‹¬å·åŒ…è£¹
âœ… Markdown ä»£ç å—
âœ… ä¸­æ–‡å…¨è§’å¼•å·
âœ… å†…å®¹å«è½¬ä¹‰å­—ç¬¦
ğŸ“Š æµ‹è¯•ç»“æœ: 5/5 é€šè¿‡
âœ¨ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### 2. Linter æ£€æŸ¥

æ£€æŸ¥æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶ï¼š

```bash
# æ£€æŸ¥å…±äº«æ¨¡å—
shared/llm/parser.js: âœ… æ— é”™è¯¯

# æ£€æŸ¥åç«¯æœåŠ¡
backend/src/services/llmService.js: âœ… æ— é”™è¯¯

# æ£€æŸ¥è¾¹ç¼˜å‡½æ•°
functions/api/generate-source.js: âœ… æ— é”™è¯¯
```

### 3. æ‰“åŒ…éªŒè¯

éªŒè¯è¾¹ç¼˜å‡½æ•°æ‰“åŒ…æ­£ç¡®ï¼š

```bash
npm run build:functions
```

**è¾“å‡º**:
```
[Bundle] å¼€å§‹æ‰“åŒ… EdgeOne Functions...
[Bundle] âœ… æ‰“åŒ…æˆåŠŸï¼
[Bundle] è¾“å‡ºæ–‡ä»¶: functions/api/generate.js
```

**éªŒè¯æ‰“åŒ…æ–‡ä»¶åŒ…å«è§£æå™¨**:
```bash
grep -n "parseResponse" functions/api/generate.js
```

**ç»“æœ**:
```
292:function parseResponse(rawText) {   # â† è§£æå™¨å·²æ‰“åŒ…
444:return parseResponse(rawText);      # â† è°ƒç”¨æ­£ç¡®
```

---

## ğŸ“Š é‡æ„æ•ˆæœ

### ä»£ç è´¨é‡æå‡

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|-----|-------|-------|-----|
| **é‡å¤ä»£ç ** | 82è¡ŒÃ—2å¤„ | 0è¡Œ | âœ… -164è¡Œ |
| **ç»´æŠ¤ä½ç½®** | 2ä¸ªæ–‡ä»¶ | 1ä¸ªæ–‡ä»¶ | âœ… -50% |
| **ä¸€è‡´æ€§é£é™©** | âš ï¸ é«˜ï¼ˆæ‰‹åŠ¨åŒæ­¥ï¼‰ | âœ… æ— ï¼ˆå•ä¸€æºï¼‰ | âœ… 100%ä¸€è‡´ |
| **æµ‹è¯•è¦†ç›–** | éœ€æµ‹2å¤„ | æµ‹1å¤„å³å¯ | âœ… ç®€åŒ–50% |

### æ–‡ä»¶å˜æ›´ç»Ÿè®¡

```
æ–°å¢æ–‡ä»¶:
  shared/llm/parser.js          +99 è¡Œ

ä¿®æ”¹æ–‡ä»¶:
  backend/src/services/llmService.js     -81 è¡Œï¼ˆåˆ é™¤ parseResponse æ–¹æ³•ï¼‰
  functions/api/generate-source.js       -74 è¡Œï¼ˆåˆ é™¤ parseResponse å‡½æ•°ï¼‰

æ‰“åŒ…æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰:
  functions/api/generate.js     ~0 è¡Œï¼ˆåŒ…å«è§£æå™¨ï¼Œå¤§å°æœªæ˜æ˜¾å¢åŠ ï¼‰

å‡€å˜åŒ–: +99 -155 = -56 è¡Œä»£ç 
```

### æ¶æ„ä¼˜åŠ¿

1. **å•ä¸€çœŸå®æº** (Single Source of Truth)
   - âœ… `shared/llm/parser.js` æ˜¯å”¯ä¸€çš„è§£æé€»è¾‘å®šä¹‰
   - âœ… æ‰€æœ‰ç¯å¢ƒå¼•ç”¨åŒä¸€ä»½ä»£ç 

2. **æ˜“äºç»´æŠ¤**
   - âœ… Bug ä¿®å¤åªéœ€ä¿®æ”¹ä¸€å¤„
   - âœ… åŠŸèƒ½å¢å¼ºåªéœ€ä¿®æ”¹ä¸€å¤„
   - âœ… æµ‹è¯•åªéœ€åœ¨ä¸€ä¸ªæ¨¡å—è¿›è¡Œ

3. **ä¸€è‡´æ€§ä¿è¯**
   - âœ… åç«¯å’Œè¾¹ç¼˜å‡½æ•°è¡Œä¸ºå®Œå…¨ä¸€è‡´
   - âœ… ä¸ä¼šå‡ºç°"çº¿ä¸Šå’Œæœ¬åœ°è§£æä¸åŒ"çš„é—®é¢˜

4. **å¯æµ‹è¯•æ€§**
   - âœ… è§£æé€»è¾‘ç‹¬ç«‹æˆæ¨¡å—ï¼Œæ˜“äºå•å…ƒæµ‹è¯•
   - âœ… å¯ä»¥æ¨¡æ‹Ÿå„ç§è¾¹ç•Œæƒ…å†µ

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ¨¡å—å¯¼å…¥è·¯å¾„

**åç«¯æœåŠ¡**:
```javascript
import { parseResponse } from '../../../shared/llm/parser.js';
```
- ç›¸å¯¹è·¯å¾„: `backend/src/services/` â†’ `shared/llm/`
- Node.js åŸç”Ÿæ”¯æŒ ES6 æ¨¡å—ï¼Œæ— éœ€æ‰“åŒ…

**è¾¹ç¼˜å‡½æ•°**:
```javascript
import { parseResponse } from '../../shared/llm/parser.js';
```
- ç›¸å¯¹è·¯å¾„: `functions/api/` â†’ `shared/llm/`
- é€šè¿‡ esbuild æ‰“åŒ…æˆå•æ–‡ä»¶

### æ‰“åŒ…é…ç½®

`scripts/bundle-functions.js` å·²é…ç½® esbuildï¼Œè‡ªåŠ¨å¤„ç† `shared/` æ¨¡å—ï¼š

```javascript
esbuild.build({
  entryPoints: ['functions/api/generate-source.js'],
  bundle: true,  // â† è‡ªåŠ¨æ‰“åŒ… shared/llm/parser.js
  platform: 'node',
  format: 'esm',
  outfile: 'functions/api/generate.js',
});
```

---

## ğŸ“ Git æäº¤ä¿¡æ¯

æŒ‰ç…§çº¦å®šå¼æäº¤è§„èŒƒï¼š

```bash
git add shared/llm/parser.js
git add backend/src/services/llmService.js
git add functions/api/generate-source.js
git add functions/api/generate.js
git commit -m "refactor(llm): ç»Ÿä¸€LLMå“åº”è§£æé€»è¾‘åˆ°sharedæ¨¡å—

- åˆ›å»º shared/llm/parser.js ç»Ÿä¸€è§£æé€»è¾‘
- ç§»é™¤ backend å’Œ functions ä¸­é‡å¤çš„ parseResponse ä»£ç 
- æ¶ˆé™¤ 82 è¡Œé‡å¤ä»£ç ï¼Œé™ä½ç»´æŠ¤æˆæœ¬
- æµ‹è¯•é€šè¿‡ï¼š5/5 åœºæ™¯éªŒè¯æˆåŠŸ
- FEAT-026: ç»Ÿä¸€LLMå“åº”è§£æé€»è¾‘
"
```

---

## âœ… éªŒè¯æ¸…å•

- [x] åˆ›å»º `shared/llm/parser.js` å…±äº«æ¨¡å—
- [x] ä¿®æ”¹ `backend/src/services/llmService.js`ï¼ˆæ·»åŠ å¯¼å…¥ï¼Œåˆ é™¤æ–¹æ³•ï¼‰
- [x] ä¿®æ”¹ `functions/api/generate-source.js`ï¼ˆæ·»åŠ å¯¼å…¥ï¼Œåˆ é™¤å‡½æ•°ï¼‰
- [x] è¿è¡Œ `npm run build:functions` æ‰“åŒ…è¾¹ç¼˜å‡½æ•°
- [x] å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ5/5 åœºæ™¯ï¼‰
- [x] Linter æ£€æŸ¥é€šè¿‡ï¼ˆ0 é”™è¯¯ï¼‰
- [x] éªŒè¯æ‰“åŒ…æ–‡ä»¶åŒ…å«è§£æå™¨
- [x] æ¸…ç†ä¸´æ—¶æµ‹è¯•æ–‡ä»¶ `test-parser.js`
- [ ] Git æäº¤
- [ ] éƒ¨ç½²åˆ° EdgeOne Pages éªŒè¯çº¿ä¸Šç¯å¢ƒ

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **æäº¤ä»£ç åˆ° Git**
   ```bash
   git add .
   git commit -m "refactor(llm): ç»Ÿä¸€LLMå“åº”è§£æé€»è¾‘åˆ°sharedæ¨¡å—"
   git push origin main
   ```

2. **éƒ¨ç½²éªŒè¯**ï¼ˆç”¨æˆ·æ“ä½œï¼‰
   - EdgeOne Pages ä¼šè‡ªåŠ¨éƒ¨ç½²æœ€æ–°ä»£ç 
   - éªŒè¯çº¿ä¸Šç¯å¢ƒè§£æåŠŸèƒ½æ­£å¸¸

3. **ç›‘æ§**
   - è§‚å¯Ÿè§£æé”™è¯¯ç‡ï¼ˆåº”ä¿æŒåœ¨ 0%ï¼‰
   - ç¡®è®¤åç«¯å’Œè¾¹ç¼˜å‡½æ•°è¡Œä¸ºä¸€è‡´

---

## ğŸ“Œ å…³é”®æ”¶ç›Š

1. **ä»£ç å¤ç”¨ç‡æå‡**: 0% â†’ 100%ï¼ˆè§£æé€»è¾‘ï¼‰
2. **ç»´æŠ¤æˆæœ¬é™ä½**: ä¿®å¤ bug å·¥ä½œé‡å‡åŠ
3. **ä¸€è‡´æ€§ä¿è¯**: æ¶ˆé™¤åç«¯å’Œè¾¹ç¼˜å‡½æ•°è¡Œä¸ºå·®å¼‚é£é™©
4. **å¯æµ‹è¯•æ€§æå‡**: è§£æé€»è¾‘ç‹¬ç«‹æµ‹è¯•ï¼Œè¦†ç›–æ›´å…¨é¢
5. **ä¸ºåç»­é‡æ„é“ºè·¯**: å…¶ä»–å¯å¤ç”¨é€»è¾‘å¯ä»¥ç»§ç»­æå–åˆ° `shared/`

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `shared/llm/parser.js` - LLM å“åº”è§£æå™¨ï¼ˆæ–°å¢ï¼‰
- `backend/src/services/llmService.js` - åç«¯ LLM æœåŠ¡ï¼ˆå·²é‡æ„ï¼‰
- `functions/api/generate-source.js` - è¾¹ç¼˜å‡½æ•°æºæ–‡ä»¶ï¼ˆå·²é‡æ„ï¼‰
- `functions/api/generate.js` - è¾¹ç¼˜å‡½æ•°æ‰“åŒ…æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `feature_list.json` - åŠŸèƒ½æ¸…å•ï¼ˆFEAT-026ï¼‰
- `claude-progress.txt` - è¿›åº¦æ—¥å¿—

---

**çŠ¶æ€**: âœ… é‡æ„å®Œæˆï¼Œä»£ç å·²ä¼˜åŒ–ï¼Œç­‰å¾…æäº¤å’Œéƒ¨ç½²éªŒè¯

