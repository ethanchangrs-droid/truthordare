# "生成失败"错误排查报告

## 问题描述

**时间**: 2025-12-18 11:54  
**现象**: 有时候会提示"错误: 生成失败，请稍后再试"  
**影响**: 用户体验受影响，需要重试才能生成成功  

## 代码审查结果

### 1. 前端错误提示逻辑

**文件**: `web/src/App.jsx`

```javascript
try {
  const response = await fetch('/api/generate', { ... });
  const data = await response.json();
  
  if (response.ok) {
    setResult(data.items?.[0] || null);
  } else {
    setError(data.error || '生成失败');  // ← 这里显示错误
  }
} catch (err) {
  setError('网络错误，请稍后再试');
}
```

**分析**：
- 如果 `response.ok === false`，显示后端返回的 `data.error`
- 如果网络异常（fetch 抛错），显示"网络错误，请稍后再试"

---

### 2. 后端错误处理逻辑

#### 2.1 Backend 服务（本地开发）

**文件**: `backend/src/controllers/generateController.js`

```javascript
try {
  // 1. 调用 LLM 服务
  const rawItems = await llmService.generate({ ... });
  
  // 2. 内容安全过滤
  const filteredItems = ContentFilter.filterItems(rawItems);
  
  // 3. 返回结果
  res.json(result);
} catch (err) {
  console.error('[Controller] 生成失败:', err.message);
  if (err.message.includes('API key')) {
    res.status(500).json({ 
      error: 'LLM服务配置错误，请检查API密钥是否正确设置', 
      code: 'LLM_CONFIG_ERROR' 
    });
  } else {
    res.status(500).json({ error: `生成失败: ${err.message}` });
  }
}
```

#### 2.2 EdgeOne Functions（生产环境）

**文件**: `functions/api/generate-source.js`

```javascript
try {
  // 1. 调用 LLM
  const rawItems = await callLLM(env, { ... });
  
  // 2. 内容过滤
  const filteredItems = filterItems(rawItems, isExplicit);
  
  // 3. 返回结果
  return jsonResponse(result);
} catch (err) {
  console.error('[Function] 处理请求失败:', err);
  return jsonResponse({ 
    error: '生成失败，请稍后再试',  // ← 通用错误提示
    details: err.message 
  }, 500);
}
```

**分析**：
- EdgeOne Functions 的错误信息不够详细
- 只返回通用的"生成失败，请稍后再试"
- 虽然有 `details` 字段，但前端没有展示

---

### 3. 可能的失败原因

#### 3.1 LLM API 调用失败

**文件**: `functions/api/generate-source.js` (行 109-136)

```javascript
const response = await fetch(apiUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`
  },
  body: JSON.stringify({ ... })
});

if (!response.ok) {
  const errorText = await response.text();
  throw new Error(`LLM API 调用失败: ${response.status} ${errorText}`);
}
```

**可能原因**：
- ❌ **API 密钥无效或过期** → 401 Unauthorized
- ❌ **请求频率超限** → 429 Too Many Requests
- ❌ **API 服务故障** → 500/502/503 错误
- ❌ **网络超时** → fetch 超时异常
- ❌ **余额不足**（如果使用付费 API）→ 403 Forbidden

#### 3.2 LLM 响应解析失败

**文件**: `functions/api/generate-source.js` (行 70-82)

```javascript
function parseResponse(rawText) {
  try {
    const jsonMatch = rawText.match(/\[(.*)\]/s);
    const jsonString = jsonMatch ? `[${jsonMatch[1]}]` : rawText;
    const items = JSON.parse(jsonString);
    
    if (!Array.isArray(items)) {
      throw new Error('解析失败：响应不是数组');
    }
    
    return items.map((item, index) => ({ ... }));
  } catch (err) {
    console.error('[LLM] 解析响应失败:', rawText, err.message);
    throw new Error(`LLM响应解析失败: ${err.message}`);
  }
}
```

**可能原因**：
- ❌ **LLM 返回格式错误**（不是 JSON 数组）
- ❌ **LLM 返回空内容** → `rawText` 为空字符串
- ❌ **LLM 返回被包裹的 JSON**（如 `text\n[...]\nmore text`）
- ❌ **JSON.parse 失败**（如包含非法字符）

#### 3.3 维度选择导致的问题（新增）

**文件**: `shared/prompt/builder.js` (行 23-28)

```javascript
const dimensions = styleDimensions[style] || [];
const targetDimensionIndex = dimensions.length > 0 ? Math.floor(Math.random() * dimensions.length) : null;
const targetDimension = targetDimensionIndex !== null ? dimensions[targetDimensionIndex] : null;
```

**潜在问题**：
- ⚠️ 如果 `styleDimensions[style]` 未定义 → `dimensions = []`
- ⚠️ 如果风格名称拼写错误 → 无法找到维度定义
- ⚠️ 如果维度数组为空 → `targetDimension = null`，Prompt 可能不完整

#### 3.4 环境变量未配置

**可能原因**：
- ❌ EdgeOne 控制台未设置 `DEEPSEEK_API_KEY` 或 `TONGYI_API_KEY`
- ❌ `LLM_PROVIDER` 设置错误（非 tongyi/deepseek）

---

## 诊断步骤

### Step 1: 检查 EdgeOne 环境变量

登录 EdgeOne 控制台，确认以下环境变量：

```bash
LLM_PROVIDER=deepseek
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
```

或

```bash
LLM_PROVIDER=tongyi
TONGYI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
```

### Step 2: 查看 EdgeOne Functions 日志

在 EdgeOne 控制台中查看函数日志，搜索关键词：
- `处理请求失败`
- `LLM API 调用失败`
- `解析响应失败`

### Step 3: 本地复现测试

使用 curl 测试边缘函数（需要先部署）：

```bash
curl -X POST https://your-domain.com/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "truth",
    "style": "正常",
    "count": 1,
    "locale": "zh-CN",
    "audienceAge": "adult",
    "intensity": "medium",
    "seed": 123
  }' | jq .
```

### Step 4: 检查 LLM API 状态

手动调用 LLM API 验证：

**DeepSeek**:
```bash
curl -X POST https://api.deepseek.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "deepseek-chat",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

**通义千问**:
```bash
curl -X POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "qwen-plus",
    "messages": [{"role": "user", "content": "你好"}]
  }'
```

---

## 建议的优化方案

### 优化 1: 增强前端错误展示

**修改**: `web/src/App.jsx`

```javascript
if (response.ok) {
  setResult(data.items?.[0] || null);
} else {
  // 显示更详细的错误信息
  const errorMsg = data.details 
    ? `${data.error} (${data.details})` 
    : data.error || '生成失败';
  setError(errorMsg);
}
```

**优势**：
- ✅ 用户可以看到具体的错误原因
- ✅ 便于用户自查（如 API key 错误、余额不足等）

### 优化 2: 细化边缘函数错误处理

**修改**: `functions/api/generate-source.js`

```javascript
} catch (err) {
  console.error('[Function] 处理请求失败:', err);
  
  // 细化错误提示
  let errorMsg = '生成失败，请稍后再试';
  let errorCode = 'UNKNOWN_ERROR';
  
  if (err.message.includes('API_KEY')) {
    errorMsg = 'LLM 服务配置错误，请联系管理员';
    errorCode = 'LLM_CONFIG_ERROR';
  } else if (err.message.includes('API 调用失败: 429')) {
    errorMsg = 'LLM 服务请求频率超限，请稍后再试';
    errorCode = 'LLM_RATE_LIMIT';
  } else if (err.message.includes('API 调用失败: 401')) {
    errorMsg = 'LLM 服务认证失败，请检查 API 密钥';
    errorCode = 'LLM_AUTH_ERROR';
  } else if (err.message.includes('解析失败')) {
    errorMsg = 'LLM 响应格式异常，请重试';
    errorCode = 'LLM_PARSE_ERROR';
  }
  
  return jsonResponse({ 
    error: errorMsg,
    code: errorCode,
    details: err.message  // 保留详细信息用于调试
  }, 500);
}
```

**优势**：
- ✅ 错误信息更友好
- ✅ 便于追踪问题分类
- ✅ 保留 details 用于技术排查

### 优化 3: 添加重试机制

**修改**: `functions/api/generate-source.js` 的 `callLLM` 函数

```javascript
async function callLLM(env, params) {
  const maxRetries = 2;  // 最多重试2次
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch(apiUrl, { ... });
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`LLM API 调用失败: ${response.status} ${errorText}`);
      }
      
      const data = await response.json();
      const rawText = data.choices?.[0]?.message?.content?.trim() || '';
      
      return parseResponse(rawText);
    } catch (err) {
      lastError = err;
      console.warn(`[LLM] 第 ${attempt} 次尝试失败:`, err.message);
      
      // 如果是最后一次尝试，直接抛出错误
      if (attempt === maxRetries) {
        throw lastError;
      }
      
      // 等待一段时间后重试（指数退避）
      await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
    }
  }
}
```

**优势**：
- ✅ 提高成功率（应对临时网络问题）
- ✅ 指数退避策略避免频繁重试
- ✅ 只在必要时重试，避免浪费配额

### 优化 4: 添加超时控制

**修改**: `functions/api/generate-source.js`

```javascript
const response = await fetch(apiUrl, {
  method: 'POST',
  headers: { ... },
  body: JSON.stringify({ ... }),
  signal: AbortSignal.timeout(15000)  // 15秒超时
});
```

**优势**：
- ✅ 避免长时间等待
- ✅ 提升用户体验（快速失败）

### 优化 5: 风格名称容错

**修改**: `shared/prompt/builder.js`

```javascript
export function buildPrompt({ mode, style, locale, count, audienceAge, intensity, seed }) {
  const isExplicit = style === '大尺度';
  
  // 风格名称容错：如果找不到维度定义，使用"正常"风格作为兜底
  const dimensions = styleDimensions[style] || styleDimensions['正常'] || [];
  
  if (dimensions.length === 0) {
    console.warn(`[Prompt] 未找到风格 "${style}" 的维度定义，使用空维度`);
  }
  
  const targetDimensionIndex = dimensions.length > 0 ? Math.floor(Math.random() * dimensions.length) : null;
  const targetDimension = targetDimensionIndex !== null ? dimensions[targetDimensionIndex] : null;
  
  // ... 其余代码
}
```

**优势**：
- ✅ 避免因风格名称错误导致生成失败
- ✅ 提供兜底机制

---

## 监控建议

### 1. 添加错误统计

在 EdgeOne Functions 中添加错误计数：

```javascript
const errorStats = {
  total: 0,
  apiError: 0,
  parseError: 0,
  configError: 0
};

// 在 catch 块中统计
errorStats.total++;
if (err.message.includes('API 调用失败')) errorStats.apiError++;
if (err.message.includes('解析失败')) errorStats.parseError++;
// ...

console.log('[Stats] 错误统计:', errorStats);
```

### 2. 定期检查 API 额度

- 设置告警：当 API 余额低于阈值时通知
- 监控请求成功率：低于 95% 时排查

### 3. 用户反馈收集

在前端添加"报告问题"按钮，收集用户遇到的具体错误信息。

---

## 立即行动项

### 高优先级（建议立即实施）

1. ✅ **检查 EdgeOne 环境变量配置**
   - 确认 API Key 正确设置
   - 确认 LLM_PROVIDER 配置正确

2. ✅ **查看 EdgeOne Functions 日志**
   - 找到最近的错误日志
   - 确认具体的失败原因

3. ✅ **优化前端错误展示**
   - 显示 `details` 字段
   - 便于用户了解具体错误

### 中优先级（建议近期实施）

4. ⏳ **细化边缘函数错误处理**
   - 区分不同错误类型
   - 提供更友好的错误提示

5. ⏳ **添加重试机制**
   - 应对临时网络问题
   - 提高成功率

### 低优先级（可选优化）

6. ⏳ **添加超时控制**
7. ⏳ **风格名称容错**
8. ⏳ **错误监控统计**

---

## 总结

"生成失败"错误最可能的原因：

1. **LLM API 调用失败**（占比最高）
   - API 密钥错误/过期
   - 请求频率超限
   - API 服务故障
   - 网络超时

2. **LLM 响应解析失败**
   - 返回格式不符合预期
   - 返回空内容

3. **环境变量未配置**
   - EdgeOne 控制台缺少必要的环境变量

**建议**：
1. 先检查 EdgeOne 环境变量和日志，确认根本原因
2. 优化前端错误展示，让用户看到具体错误
3. 细化后端错误处理，提供友好提示
4. 添加重试机制和超时控制，提高成功率

---

**执行人**: Claude AI  
**完成时间**: 2025-12-18 11:54 (UTC+8)

