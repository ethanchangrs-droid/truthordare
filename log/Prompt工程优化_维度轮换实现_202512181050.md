# Prompt 工程优化：LLM 维度轮换实现

**文档类型**: 技术总结  
**创建时间**: 2025-12-18 10:50  
**相关任务**: FEAT-025 题目多样性优化  
**问题严重性**: P0（用户反馈题目重复率高，体验差）

---

## 一、问题背景

### 1.1 用户反馈
- **暧昧风格**: 所有题目都围绕"心动"这一单一话题
- **搞笑风格**: 所有题目都是"表演"类，没有其他类型

### 1.2 预期效果
每种风格应该有 8 个不同的话题维度，题目应在这 8 个维度之间轮换，确保多样性。

例如搞笑风格的 8 个维度：
1. 尴尬糗事
2. 童年趣事
3. 模仿表演
4. 奇葩经历
5. 社死瞬间
6. 恶搞挑战
7. 荒诞想象
8. 沙雕行为

---

## 二、问题诊断过程

### 2.1 Phase 1: 定义维度
- **实现**: 在 `shared/prompt/dimensions.js` 中为 12 种风格各定义 8 个话题维度
- **结果**: ❌ 题目仍然单一，LLM 没有轮换维度

### 2.2 Phase 2-3: 优化缓存
- **实现**: 随机数范围 1~100 → 1~1000，添加 LRU 缓存（maxSize: 100）
- **结果**: ❌ 题目多样性没有改善

### 2.3 Phase 4: seed 传递给 LLM
- **实现**: 将 `seed` 参数加入 Prompt（`题目编号：${seed}`）
- **结果**: ❌ 题目仍然单一

### 2.4 Phase 5-6: 提高随机性
- **实现**: 
  - `temperature` 从 0.7 提升到 1.0
  - 添加 `frequency_penalty: 1.5`
  - 添加 `presence_penalty: 1.2`
- **结果**: ⚠️ 有轻微改善，但"搞笑"风格仍全是"表演"类

### 2.5 Phase 7: 发现根本问题
**测试结果分析**（搞笑风格，dare 模式）：
```bash
Seed 1 (应该是"童年趣事"): 用最夸张的肢体动作和声音，表演...  # 实际是表演
Seed 2 (应该是"模仿表演"): 请用最浮夸的演技，模仿...       # 实际是模仿
Seed 3 (应该是"奇葩经历"): 用最浮夸的演技，向在场...       # 实际是表演
Seed 4 (应该是"社死瞬间"): 请用最夸张的肢体语言...         # 实际是表演
Seed 5 (应该是"恶搞挑战"): 用你自认为最性感的姿势...       # 实际是表演
Seed 6 (应该是"荒诞想象"): 请用最严肃的表情和语气...       # 实际是表演
```

**关键发现**：
1. 虽然 Prompt 列出了 8 个维度，但 LLM 只倾向于生成它认为最"典型"的题目
2. 对于"搞笑"风格，LLM 认为"表演"是最典型的表现形式
3. "随机选择维度"这种指令对确定性模型来说太模糊

---

## 三、解决方案

### 3.1 核心思路
**从"建议随机"改为"明确指定"**

**原 Prompt 逻辑**（失败）：
```javascript
userPrompt += `
可选话题维度：
1. 尴尬糗事
2. 童年趣事
3. 模仿表演
...
8. 沙雕行为

⚠️ 重要：每次生成时，请从上述话题维度中**随机选择一个维度**。
`;
```

**问题**：
- LLM 无法理解"随机"的真实含义
- 确定性模型倾向于选择它认为最典型的选项
- 没有外部约束，LLM 会忽略"建议"

**新 Prompt 逻辑**（成功）：
```javascript
// 基于 seed 计算本次使用的维度索引
const dimensions = styleDimensions[style] || [];
const targetDimensionIndex = seed % dimensions.length;
const targetDimension = dimensions[targetDimensionIndex];

userPrompt += `
🎯 本次核心话题维度：【${targetDimension}】
⚠️ 请严格围绕"${targetDimension}"这个维度设计题目内容，不要偏离到其他维度。
如果维度是"童年趣事"，就不要设计成"模仿表演"；
如果维度是"尴尬糗事"，就设计回忆尴尬经历的问题或任务，而不是表演类。
每个维度都有独特的表达方式，请充分发挥创意。
`;
```

**关键改进**：
1. **明确性**: 直接告诉 LLM "本次使用哪个维度"
2. **约束性**: "请严格围绕...不要偏离"
3. **举例说明**: 用反例明确哪些是"偏离"
4. **确定性**: 同一 seed 总是对应同一维度（`seed % 8`）

### 3.2 代码实现

**文件**: `shared/prompt/builder.js`

```javascript
export function buildPrompt({ mode, style, locale, count, audienceAge, intensity, seed }) {
  // 基于 seed 确定本次使用的维度（确保同一 seed 对应同一维度）
  const dimensions = styleDimensions[style] || [];
  const targetDimensionIndex = dimensions.length > 0 ? (seed % dimensions.length) : null;
  const targetDimension = targetDimensionIndex !== null ? dimensions[targetDimensionIndex] : null;
  
  // ... systemPrompt 构建 ...

  // 构建 userPrompt，明确指定本次使用的维度
  let userPrompt = `
语言：${locale}；模式：${mode}；风格：${style}；数量：${count}
受众年龄：${audienceAge}；尺度：${intensity}；题目编号：${seed || 'N/A'}`;

  if (targetDimension) {
    userPrompt += `\n\n🎯 本次核心话题维度：【${targetDimension}】
⚠️ 请严格围绕"${targetDimension}"这个维度设计题目内容，不要偏离到其他维度。
如果维度是"童年趣事"，就不要设计成"模仿表演"；
如果维度是"尴尬糗事"，就设计回忆尴尬经历的问题或任务，而不是表演类。
每个维度都有独特的表达方式，请充分发挥创意。`;
  }

  userPrompt += `\n\n请生成 ${count} 条符合要求的内容，严格遵守 JSON 格式。`;

  return {
    system: systemPrompt.trim(),
    user: userPrompt.trim()
  };
}
```

---

## 四、测试结果

### 4.1 搞笑风格（8 个维度全覆盖）

| Seed | 维度索引 | 维度名称 | 生成题目类型 | 结果 |
|------|----------|----------|--------------|------|
| 0 | 0 | 尴尬糗事 | 讲述经历 | ✅ |
| 1 | 1 | 童年趣事 | （未测试，频率限制） | - |
| 2 | 2 | 模仿表演 | 表演任务 | ✅ |
| 3 | 3 | 奇葩经历 | 讲述挑战 | ✅ |
| 4 | 4 | 社死瞬间 | 播放挑战 | ✅ |
| 5 | 5 | 恶搞挑战 | 任务挑战 | ✅ |
| 6 | 6 | 荒诞想象 | 解释挑战 | ✅ |
| 7 | 7 | 沙雕行为 | 对话挑战 | ✅ |

**结论**: ✅ 题目类型与维度完全对应，不再全是"表演"类

### 4.2 暧昧风格（抽样测试）

| Seed | 维度索引 | 维度名称 | 生成题目主题 | 结果 |
|------|----------|----------|--------------|------|
| 0 | 0 | 初次见面的印象 | "你对我的第一印象是..." | ✅ |
| 7 | 7 | 亲密关系边界 | "在亲密关系中如何定义边界..." | ✅ |

**结论**: ✅ 题目不再全是"心动"相关，维度轮换生效

---

## 五、关键经验教训

### 5.1 Prompt 工程原则

#### ❌ 错误做法
```
可选选项：A、B、C
请随机选择一个选项。
```

**问题**：
- 确定性模型无法真正"随机"
- LLM 会倾向于选择它认为最"典型"或"安全"的选项
- "建议"性指令容易被忽略

#### ✅ 正确做法
```
本次必须使用选项：B
请严格围绕选项 B，不要使用其他选项。
```

**原理**：
- 明确性：不留模糊空间
- 约束性：强制执行
- 确定性：外部逻辑控制（如 `seed % options.length`）

### 5.2 维度轮换的实现策略

| 策略 | 实现方式 | 优点 | 缺点 | 结果 |
|------|----------|------|------|------|
| **策略 1**: 列出所有维度 | 在 Prompt 中列举 8 个维度 | 简单 | LLM 会偏向某些维度 | ❌ 失败 |
| **策略 2**: 增加随机性参数 | temperature=1.0 + penalties | 一定改善 | 仍有偏向性 | ⚠️ 部分有效 |
| **策略 3**: 明确指定维度 | 基于 seed 计算维度，强制使用 | 完全控制 | 需要外部逻辑 | ✅ 成功 |

**结论**: **外部逻辑控制 + 明确指令** 是确保多样性的最佳方案

### 5.3 LLM 行为理解

1. **确定性模型的"偏好"**
   - LLM 在训练数据中学到了某些"典型"关联
   - 例如："搞笑" → "表演"、"暧昧" → "心动"
   - 这些偏好很难通过 Prompt 中的"建议"消除

2. **"随机"的误解**
   - LLM 无法真正执行"随机选择"
   - 即使设置高 `temperature`，仍会倾向于某些输出
   - 真正的"随机"需要外部控制（如 seed-based routing）

3. **明确性的重要性**
   - 模糊指令（"尽量"、"随机"、"可能"）效果差
   - 明确指令（"必须"、"严格"、"本次使用"）效果好
   - 配合反例说明（"不要做 X"）更有效

---

## 六、后续优化方向

### 6.1 短期优化
- ✅ 已实现基于 seed 的维度轮换
- ⏳ 部署到 EdgeOne 验证生产环境效果
- ⏳ 收集用户反馈，微调维度定义

### 6.2 中期优化
- 考虑在 `shared/prompt/dimensions.js` 中为每个维度添加更详细的"维度说明"
- 例如：
  ```javascript
  {
    name: '童年趣事',
    description: '回忆童年时期的有趣经历，如学校、家庭、玩耍等场景',
    examples: ['童年恶作剧', '学校糗事', '家庭趣事']
  }
  ```

### 6.3 长期优化
- 实现"维度权重"机制，某些维度可设置更高出现概率
- 实现"维度黑名单"，用户可屏蔽某些维度
- 收集题目质量反馈，持续优化各维度的 Prompt 模板

---

## 七、代码变更记录

### 7.1 修改的文件
- `shared/prompt/builder.js`: 添加基于 seed 的维度计算逻辑
- `shared/prompt/dimensions.js`: 导出 `styleDimensions` 供 builder 使用

### 7.2 影响范围
- ✅ backend（通过 import 自动生效）
- ✅ functions（需重新打包：`npm run build:functions`）

### 7.3 Git 提交
```bash
git add shared/prompt/builder.js
git commit -m "feat(prompt): 基于 seed 明确指定维度 - 解决 LLM 维度偏好问题

- 使用 seed % dimensions.length 计算维度索引
- Prompt 中明确指定本次使用的维度
- 添加反例说明，防止维度偏离
- 测试结果：搞笑风格不再只出表演类题目"
```

---

## 八、总结

### 8.1 核心成果
- **问题**: LLM 生成题目时倾向于某些"典型"维度，缺乏多样性
- **根因**: Prompt 中的"随机选择"指令对确定性模型无效
- **方案**: 外部逻辑（seed % dimensions.length）计算维度 + Prompt 明确指定
- **效果**: 题目类型从单一维度提升到 8 维度确定性轮换

### 8.2 技术价值
这次优化不仅解决了题目多样性问题，更重要的是总结了一套 **Prompt 工程的最佳实践**：
1. ❌ 不要依赖 LLM 的"随机"或"自主选择"
2. ✅ 使用外部逻辑控制 + 明确指令
3. ✅ 配合反例说明，防止偏离

这套方法论可应用于所有需要"多样性"的 LLM 场景。

---

**文档版本**: V1.0  
**最后更新**: 2025-12-18 10:50  
**负责人**: Claude AI Agent

