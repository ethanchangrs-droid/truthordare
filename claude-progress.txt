# 真心话/大冒险 LLM 生成器 - AI 代理进度日志

---

## 最新状态

| 属性 | 内容 |
|------|------|
| 最后更新 | 2025-12-18 11:15 |
| 当前功能 | Truth/Dare 模式区分优化 + 社牛风格 |
| 代码状态 | ✅ 可运行（已测试并推送） |
| 最后 Commit | 539ac55 |

## 本次验证

- ✅ Truth 模式：严格为"讲述/回答"类型
- ✅ Dare 模式：严格为"执行动作"类型
- ✅ "社牛"风格添加成功（8个维度）
- ✅ API 响应格式正常，前端兼容
- ✅ 已推送到 GitHub

---

## 项目进度总览

- **总功能数**: 25
- **已完成**: 10 (FEAT-001/003/004/005/006/022/023/024/025 + 部分FEAT-002)
- **进行中**: 0
- **待开始**: 15 (FEAT-007~021)
- **完成率**: 40.0%

---

## 会话记录

### 2025-12-18 会话 7 🎯 Truth/Dare 模式区分 + 社牛风格

**执行时间**: 2025-12-18 10:50 - 11:15

**用户反馈**:
1. **Truth 和 Dare 区别不明显**: 
   - Truth 应该倾向于"讲"（讲故事、描述）
   - Dare 应该倾向于"做"（执行具体动作）
2. **新增需求**: 添加"社牛"（社交牛逼症）风格

**问题诊断**:
- 测试发现 Truth 模式偶尔会出现"模仿"、"表演"等动作类题目
- Dare 模式基本正确
- 原 Prompt 对模式特性的描述不够强

**解决方案**:
1. ✅ **强化 Truth/Dare 区分**
   - 在 `shared/prompt/builder.js` 中添加 `modeInstruction`
   - Truth 模式明确要求：
     - ✅ 必须：提问、询问、讲述、描述、回答、分享
     - ❌ 禁止：模仿、表演、做动作、执行任务等动词
   - Dare 模式明确要求：
     - ✅ 必须：命令、指令、模仿、表演、做出、完成
     - ❌ 禁止：只需说话回答的内容
   - 配合正反示例，防止混淆

2. ✅ **新增"社牛"风格**
   - 在 `shared/prompt/dimensions.js` 添加 8 个维度：
     - 大胆搭讪、公开表演、社交挑战、即兴演讲
     - 陌生人互动、自我展示、破冰游戏、勇敢表达
   - 在 `web/src/App.jsx` 风格列表中添加"社牛"

**测试结果**:
- ✅ Truth 模式（社牛风格）：
  - "说说你用过最大胆的一次搭讪..."
  - "讲述一次你在公开场合表演时..."
  - 全部为"讲述/描述"类 ✅
  
- ✅ Dare 模式（社牛风格）：
  - "请立刻起身，走到陌生人面前..."
  - "向派对里任意一位异性，用最直接的方式..."
  - 全部为"执行动作"类 ✅

- ✅ API 响应格式验证：
  - `items[0].type` 正确输出 "truth" 或 "dare"
  - `items[0].text` 包含题目内容
  - 前端解析完全兼容 ✅

**文件变更**:
- 修改: `shared/prompt/builder.js` - 添加 modeInstruction 逻辑
- 修改: `shared/prompt/dimensions.js` - 添加"社牛"风格维度
- 修改: `web/src/App.jsx` - 风格列表添加"社牛"
- 打包: `functions/api/generate.js` - 重新打包

**Git 提交**:
- 539ac55: feat: 强化 truth/dare 模式区分 + 新增社牛风格

**关键改进**:
- 🎯 Truth/Dare 模式区分从"模糊建议"到"明确禁止"
- 🎨 新增"社牛"风格，满足社交挑战场景需求
- ✅ Prompt 工程优化：使用正反示例 + 明确禁止指令

**下一步**:
- ⏳ 部署到 EdgeOne Pages 验证
- ⏳ 更新 docs 文档

---

### 2025-12-18 会话 6 🎯 架构优化 + 题目多样性提升

**执行时间**: 2025-12-18 02:00 - 10:50

**问题诊断**:
1. **题目重复严重**: 所有"暧昧"风格题目都围绕"心动"单一话题
2. **搞笑风格单一**: 所有题目都是"表演"类，没有覆盖其他7个维度
3. **代码重复**: Prompt 逻辑在 backend 和 functions 两处维护，修改需同步
4. **参数硬编码**: temperature、penalty 等参数写死在代码中

**解决方案**:
1. ✅ **提取公共模块** (FEAT-024)
   - 创建 `shared/prompt/dimensions.js` - 12种风格×8个话题维度
   - 创建 `shared/prompt/builder.js` - Prompt 构建逻辑（单一真实源）
   - 创建 `shared/config/llm-params.js` - LLM 参数配置（temperature=1.0, penalties=1.5/1.2）
   - backend 直接 import shared/
   - functions 通过 esbuild 打包 shared/
   - 配置 `npm run build:functions` 打包命令

2. ✅ **题目多样性优化** (FEAT-025)
   - **Phase 1**: 为每种风格定义8个话题维度（如暧昧：初次见面、性吸引力、约会细节...）
   - **Phase 2**: 优化随机数范围 1~1000（命中率降至0.1%）
   - **Phase 3**: 实现 LRU 缓存（maxSize: 100）
   - **Phase 4**: seed 参数传递给 LLM（加入 prompt）
   - **Phase 5**: 提高 temperature 到 1.0
   - **Phase 6**: 添加 frequency_penalty=1.5, presence_penalty=1.2
   - **Phase 7**: **基于 seed 明确指定维度** - 使用 `seed % 8` 计算维度索引，在 Prompt 中明确指定本次使用的维度（如"本次核心话题维度：【童年趣事】"），强制 LLM 围绕该维度生成题目

**关键突破**（Phase 7）:
- **问题**: LLM 倾向于生成它认为最"典型"的题目（如搞笑→表演），即使列出了8个维度也不会轮换
- **根本原因**: Prompt 只是"建议"LLM 随机选择，但确定性模型对"随机"概念理解不佳
- **解决方案**: 基于 `seed % dimensions.length` 计算维度索引，在 Prompt 中明确指定"本次核心话题维度：【X】"并强调"请严格围绕该维度，不要偏离到其他维度"
- **结果**: 同一 seed 总是对应同一维度，不同 seed 轮换不同维度，确保了确定性和多样性

**测试结果**:
- ✅ 搞笑风格（8个维度测试）：
  - Seed 0（尴尬糗事）：讲述经历 ✅
  - Seed 2（模仿表演）：表演任务 ✅
  - Seed 4（社死瞬间）：播放挑战 ✅
  - Seed 6（荒诞想象）：对话挑战 ✅
- ✅ 暧昧风格（2个维度测试）：
  - Seed 0（初次见面的印象）：第一印象 ✅
  - Seed 7（亲密关系边界）：边界问题 ✅

**文件变更**:
- 新增: `shared/prompt/dimensions.js`, `shared/prompt/builder.js`, `shared/config/llm-params.js`
- 新增: `functions/api/generate-source.js` (引用 shared/)
- 新增: `scripts/bundle-functions.js` (打包脚本)
- 修改: `backend/src/services/llmService.js` (引用 shared/)
- 修改: `shared/prompt/builder.js` (**Phase 7: 基于 seed 计算维度索引并明确指定**)
- 修改: `backend/.env.example` (移除冗余参数)
- 新增: `package.json` (打包命令)
- 备份: `functions/api/generate-backup.js`

**Git 提交**:
- dd18d93: refactor: 提取公共模块 - prompt 和 LLM 参数统一管理
- e2f4dca: feat: 为每种风格添加话题维度定义 - 解决题目话题单一问题
- 8c35312: feat: 添加重复惩罚参数
- e72ee04: feat: 提高 temperature 到 1.0
- e660ca4: fix: 将 seed 参数传递给 LLM
- 67c1158: feat: 优化缓存策略 - 1~1000随机数 + 100条上限
- d5a937f: feat(prompt): 基于 seed 明确指定维度 - 解决 LLM 维度偏好问题

**关键改进**:
- 🎯 题目多样性从单一话题提升到8维度确定性轮换
- 🔧 代码复用率100%（prompt逻辑单一真实源）
- ⚙️ 参数配置化（便于调优）
- 📦 打包自动化（`npm run build:functions`）
- 💡 **Prompt 工程突破**: 从"建议随机"到"明确指定"，解决了 LLM 维度偏好问题

**下一步**:
- ⏳ 提交 Git
- ⏳ 推送到 GitHub
- ⏳ 部署到 EdgeOne 验证
- ⏳ 更新 docs 文档到 V1.4

---

### 2025-12-17 会话 1

**完成内容**:
- ✅ 项目评估与优化
  - 修复小程序 WXML 数据绑定 bug
  - 实现 Web 端复制功能（单条+全部）
  - 添加 Web 端「再来一题」按钮
  - 小程序 API 地址提取到配置文件
  - 补充 Web 端缺失文件（index.html, Tailwind配置）
- ✅ 代码与文档对齐
  - 风格枚举：11项
  - API 参数名统一
  - 添加底部免责声明
- ✅ 文档版本更新 V1.0 → V1.1
- ✅ 扩展功能清单到16项，添加 priority/category/steps 字段
- ✅ 端到端测试通过（Web端）
- ✅ 恢复「长时间代理工作流使用指南」到初始版本
- ✅ 按模板格式更新 feature_list.json 和 claude-progress.txt

**当前状态**:
- Web端功能100%完成，所有测试通过
- 代码与文档完全一致
- 功能清单已标准化，符合模板格式

**本次验证**:
- 结果：✅ Web端通过
- 证据：浏览器自动化测试记录在会话中

**下一步**:
1. FEAT-002：小程序端真机测试（P0优先级）
2. FEAT-006：实现缓存功能（P1优先级）
3. FEAT-010：配置生产环境API域名（P1优先级）

### 2025-12-17 会话 2

**完成内容**:
- ✅ FEAT-006：实现缓存功能
  - 安装 node-cache 依赖
  - 创建 cacheService.js 模块（MD5 key生成、统计信息）
  - 在 generateController 集成缓存逻辑
  - 配置 TTL 10分钟（600秒）
  - API 响应添加 `cached` 字段标识缓存状态

**本次验证**:
- 方法：curl 命令行测试
- 测试用例：
  1. 首次请求（truth/正常）→ `cached: false`, latencyMs: 5071ms ✅
  2. 重复请求（truth/正常）→ `cached: true`, latencyMs: 0ms ✅
  3. 不同参数（dare/正常）→ `cached: false`, latencyMs: 5916ms ✅
  4. 重复不同参数 → `cached: true`, latencyMs: 0ms ✅
- 结果：✅ 通过（缓存命中率100%，延迟降低到0ms）

**当前状态**:
- 缓存功能100%完成并测试通过
- 性能提升显著：重复请求延迟从~5s降至0ms
- 代码可运行，无语法错误

**下一步**:
1. FEAT-002：小程序端真机测试（P0优先级）
2. FEAT-010：配置生产环境API域名（P1优先级）
3. FEAT-007~016：其他优化功能

### 2025-12-17 会话 3

**完成内容**:
- ✅ 环境变量配置排查与优化
  - 创建详细的环境变量配置排查报告
  - 修正小程序开发环境端口配置（3001 → 3002）
  - 创建 backend/.env.example 模板文件
  - 更新 .gitignore，正确忽略 .env 文件
  - 更新 backend/README.md，添加详细的环境变量说明
  - 更新 init.sh，添加环境变量配置检查和提示

**本次修正**:
- 类型：配置错误修正 + 文档完善
- P0 问题：小程序开发环境 API 端口错误（3001 → 3002）✅
- 新增文件：
  - backend/.env.example（环境变量模板）
  - log/环境变量配置排查报告_202512171641.md（452行）

**当前状态**:
- 环境变量配置规范化完成
- 小程序开发环境端口已修正
- 文档完整性提升

**下一步**:
1. FEAT-002：小程序端真机测试（P0优先级）
2. FEAT-010：配置生产环境API域名（P1优先级）
3. FEAT-017：迁移 LLM Base URLs 到环境变量（P1优先级）
4. FEAT-018：迁移 LLM 模型名称到环境变量（P1优先级）

**新增任务**（基于环境变量配置排查）:
- FEAT-017：迁移 LLM Base URLs 到环境变量（P1）
- FEAT-018：迁移 LLM 模型名称到环境变量（P1）
- FEAT-019：迁移 LLM 参数到环境变量（P2）
- FEAT-020：迁移缓存配置到环境变量（P2）
- FEAT-021：Web 端环境变量配置（P2）

### 2025-12-17 会话 4

**完成内容**:
- ✅ FEAT-022：EdgeOne Pages Functions 改造
  - 创建 `functions/api/generate.js` 边缘函数
  - 迁移 LLM 调用逻辑（通义千问/DeepSeek）
  - 迁移内容过滤逻辑（敏感词过滤）
  - 实现边缘函数内存缓存
  - 创建 `pages.json` EdgeOne 配置文件
  - 更新 `vite.config.js` 构建配置
  - 更新 `DEPLOY_EDGEONE.md` 部署文档
  - 更新 `README.md` 项目说明
  - 更新 `feature_list.json` 添加 FEAT-022

**架构变更**:
- 从「前端 + 后端服务器」改为「前端 + 边缘函数」
- 无需单独部署后端服务器
- 代码推送到 GitHub 后 EdgeOne 自动部署

**当前状态**:
- EdgeOne Pages Functions 改造完成
- 部署架构简化，无需运维服务器
- 项目完成率提升至 31.8%

**下一步**:
1. 推送代码到 GitHub
2. 在 EdgeOne 控制台部署项目
3. 配置环境变量（LLM_PROVIDER, API Keys）
4. FEAT-002：小程序端真机测试

### 2025-12-17 会话 5

**需求变更**:
1. 每次只生成1题，响应时间 < 1s
2. 禁用再来一题按钮和复制按钮（注释掉）
3. 缓存逻辑：前端生成1~100随机数作为seed参数，相同seed命中缓存（约1%命中率）
4. 新增"大尺度"风格：成人暧昧/性暗示 + 轻度暴力挑战
5. 放宽敏感词：暧昧/性暗示、酒精、轻度恶作剧
6. 保留限制：违法、未成年保护、歧视
7. 移除限制：隐私相关
8. 限流放宽：6次/分钟 → 20次/分钟
9. 防抖：生成过程中按钮禁用

**完成内容**:
- ✅ FEAT-023：需求变更实现
  - 前端 count 改为 1
  - 注释复制按钮和再来一题按钮
  - 新增"大尺度"风格（红色高亮+18+警告）
  - 前端生成随机数 seed 参数
  - 边缘函数缓存逻辑改用 mode:style:seed
  - 调整敏感词库
  - 大尺度风格特殊 Prompt
  - 更新 docs 文档到 V1.3
  - 旧版文档归档到 docs/archive/

**当前状态**:
- 需求变更实现完成
- 项目完成率提升至 34.8%

**下一步**:
1. 推送代码到 GitHub
2. 在 EdgeOne 控制台部署并测试
3. FEAT-002：小程序端真机测试

---

## 下一个待完成功能

| ID | 描述 | 优先级 |
|----|------|--------|
| FEAT-002 | 小程序端：选择模式与风格并生成（真机测试） | P0 |

---

## 已知问题

- [ ] 小程序需要在微信开发者工具中测试（无法在浏览器验证）
- [ ] Web组件未拆分，集成在App.jsx中（FEAT-008，P2优先级）
- [x] 需要单独部署后端服务器（已通过 EdgeOne Pages Functions 解决）
- [ ] 复制和再来一题按钮已禁用（根据需求变更）

---
